{% extends "base.html" %}

{% load static %}

{% block title %}Проверка рецензирования{% endblock %}

{% block extra_head %}
    <link rel="stylesheet" href="{% static 'css/exercise_app.css' %}" />
    <link rel="stylesheet" href="{% static 'css/review.css' %}" />
{% endblock %}

{% block content %}   

<div class="main-container">

    <div class="review-menu">
        <div class="review-menu-block grey-block">
            Студент: {{ exercise.idstudent.iduser.get_full_name }}
         </div>

         <div class="review-menu-block grey-block">
            Дата создания: {{ exercise.creationdate }}
         </div>

         <div class="review-menu-block grey-block">
            Срок сдачи: {{ exercise.deadline }}
         </div>

         {% if exercise.exercisestatus %}
            {% if in_time %}
            <div class="review-menu-block green-block">
                Дата сдачи: {{ exercise.completiondate }}
            </div>
            {% else %}
            <div class="review-menu-block red-block">
                Дата сдачи: {{ exercise.completiondate }}
            </div>
            {% endif %}
        {% endif %}

         <div class="review-menu-button rate-btn">
            Оценить
         </div>
    </div>

    <div class="task-container">
        <h3>Задание к тексту:</h3>
        <p class="separator">
            {{ exercisereview.idexercisetexttask.tasktitle }}
        </p>
        <p>
            {{ exercisereview.idexercisetexttask.tasktext }}
        </p>
    </div>

    <div class="review-body" id="reviewBody">
        <div class="review-text-container-e" id="reviewTextContainer">
            <div class="text-header underline">
                <h2>{{ text_metadata.exercisetextname }}</h2>
                <p class="author">{{ text_metadata.author }}</p>
                <p class="author"> {{ text_metadata.idexercisetexttype.exercisetexttypename }} </p>
            </div>

            <div class="review-text">
                {{ text|safe }}
            </div>
        </div>

        <div class="review-container" id="reviewContainer">
            <div class="review-container-header">
                <h3 class="underline">Ответ студента</h3>
                <button class="close-review" id="closeReview">&#10006;</button>                
            </div>

            <div class="student-review separator" id="review"></div>

            <div class="teacher-comment">
                <h3>Комментарий преподавателя</h3>
                <div id="comment"> </div>
            </div>

             <form id="commentForm" style="display: none;">
                {% csrf_token %}
                <div class="form-group">
                    <textarea id="commentInput" class="form-control" rows="4" 
                                placeholder="Введите ваш комментарий..."></textarea>
                    <div id="commentError" class="error-message" style="color: red; display: none;"></div>
                </div>
                <div class="review-buttons">
                    <button type="submit" class="button">Сохранить</button>
                    <button type="button" class="button grey-button" id="cancelEdit">Отмена</button>
                </div>
            </form>
                
            <!-- Кнопки управления комментарием -->
            <div class="review-buttons" id="commentControls">
                <button type="button" class="button" id="editCommentBtn">Изменить</button>
                <button type="button" class="button" id="addCommentBtn">Добавить комментарий</button>
            </div>

            <!-- <form id="create-comment-form">
                <div class="review-buttons">
                    <button>Сохранить</button>
                    <button>Отмена</button>                    
                </div>
            </form>

            <form id="edit-comment-form">
                <div class="review-buttons">
                    <button>Изменить</button>
                    <button>Удалить</button>                    
                </div>
            </form> -->
        </div>
    </div> 

    <!-- Модальное окно для оценки -->
    <div class="modal-overlay" id="modal">
        <div class="modal-content">
            <div class="modal-head">
                <p>Оценить упражнение</p>
                <button class="close-modal">
                    <svg width="30" height="30" viewBox="0 0 44 44" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M27.101 17.0606L17.0606 27.101M17.0606 17.0606L27.101 27.101M12.0404 4.68683C15.0917 2.92153 18.5556 1.99459 22.0808 2.00002C33.1714 2.00002 42.1616 10.9902 42.1616 22.0808C42.1616 33.1714 33.1714 42.1616 22.0808 42.1616C10.9902 42.1616 2 33.1714 2 22.0808C2 18.4241 2.97794 14.9923 4.68681 12.0404" stroke="white" stroke-width="2.5" stroke-linecap="round" />
                    </svg>
                </button>
            </div>

            <form method="post" id="mark-form">
                {% csrf_token %}
                <div class="form-fields">
                    <label for="{{ mark_form.exercisemark.label.id_for_label }}" class="no-highlight">
                        {{ mark_form.exercisemark.label }}
                    </label>
                    {{ mark_form.exercisemark }}

                    <label for="{{ mark_form.exercisemarkcomment.label.id_for_label }}" class="no-highlight">
                        {{ mark_form.exercisemarkcomment.label }}
                    </label>
                    {{ mark_form.exercisemarkcomment }}
                </div>

                <div class="grade-buttons">
                    <button type="submit" name="mark-form" class="button" onclick="addAnnotation()">Сохранить</button>
                    <button type="button" class="button grey-button">Назад</button>
                </div>
            </form>
        </div>
    </div>

</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const rateBtn = document.querySelector('.rate-btn');
        const modal = document.getElementById('modal');
        const closeModal = document.querySelector('.close-modal');
        const backButton = document.querySelector('.grey-button');

        // Обработчики для модального окна
        if (backButton) {
            backButton.addEventListener('click', function(e) {
                e.preventDefault(); // Предотвращает отправку формы
                modal.style.display = 'none';
            });
        }

        rateBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            document.querySelectorAll('.menu-content').forEach(c => {
                    c.style.display = 'none';
            });
            modal.style.display = 'flex';
        });

        closeModal.addEventListener('click', function() {
            modal.style.display = 'none';
        });

        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
            modal.style.display = 'none';
            }
        });
    });

    document.addEventListener('DOMContentLoaded', function(){
        const selections = document.querySelectorAll('.selection');
        const reviewContainer = document.getElementById('reviewContainer');
        const closeReview = document.getElementById('closeReview');
        const reviewText = document.getElementById('review');
        const commentText = document.getElementById('comment');
        const reviewTextContainer = document.getElementById('reviewTextContainer');

        // Функция открытия панели
        function openReviewPanel() {
            reviewContainer.classList.add('active');
            if (reviewTextContainer) {
                reviewTextContainer.classList.add('with-sidebar');
            }
            if (reviewBody) {
                reviewBody.classList.add('with-sidebar');
            }
        }

        // Функция закрытия панели
        function closeReviewPanel() {
            reviewContainer.classList.remove('active');

            if (reviewTextContainer) {
                reviewTextContainer.classList.remove('with-sidebar');
            }

            if (reviewBody) {
                reviewBody.classList.remove('with-sidebar');
            }
            
            // Сбрасываем выделение
            document.querySelectorAll('.selection').forEach(s => {
                s.classList.remove('active');
            });
        }

        // Обработчик клика по фрагменту
        selections.forEach(span => {
            span.addEventListener('click', function() {
                const fragmentId = this.getAttribute('data-fragment-id');
                const review = this.getAttribute('data-review');
                const teacherComment = this.getAttribute('data-teacher-comment');
                const fragmentText = this.textContent;

                reviewText.textContent = review;
                commentText.textContent = teacherComment || 'Комментарий отсутствует';

                document.querySelectorAll('.selection').forEach(s => {
                    s.classList.remove('active');
                });
                this.classList.add('active');

                openReviewPanel();
            });
        });
        

        function handleClickOutside(event) {
            // Если панель открыта И клик был вне панели И не по выделенному фрагменту
            if (reviewContainer.classList.contains('active') && 
                !reviewContainer.contains(event.target) && 
                !event.target.classList.contains('selection')) {
                closeReviewPanel();
            }
        }

        // Закрытие панели
        closeReview.addEventListener('click', closeReviewPanel);
        document.addEventListener('click', handleClickOutside);
        // Закрытие по ESC
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeReviewPanel();
            }
        });
        reviewContainer.addEventListener('click', function(event) {
            event.stopPropagation();
        });

    });
</script>

{% endblock %}