{% extends "base.html" %}

{% load static %}

{% block title %}Добавление упражнения{% endblock %}

{% block extra_head %}
    <link rel="stylesheet" href="{% static 'css/exercise_app.css' %}" />
{% endblock %}

{% block content %}

<div class="container">
    <h2 class="highlighted-header">Добавление упражнения</h2>
    <form method="post" class="add_exercise_form" id="exerciseForm">
        {% csrf_token %}

        <div class="form-group">
            {{ form.year.label_tag }}
            {{ form.year }}
        </div>

        <div class="form-group">
            {{ form.group.label_tag }}
            {{ form.group }}
        </div>

        <div class="form-group">
            {{ form.idstudent.label_tag }}
            {{ form.idstudent }}
        </div>

        <div class="form-group">
            {{ form.creationdate.label_tag }}
            {{ form.creationdate }}
        </div>

        <div class="form-group">
            {{ form.deadline.label_tag }}
            {{ form.deadline }}
        </div>

        <div class="grouping-wrapper">
            <label>Тип упражнения:</label>
            <div class="grouping-options">
                {% for choice in form.idexercisetype %}
                <div>
                    {{ choice.tag }}
                    <label for="{{ choice.id_for_label }}">{{ choice.choice_label }}</label>
                </div>
                {% endfor %}
            </div>
        </div>

        <div id="grading-fields" style="display: none;">
            <div class="card mb-3">
                <div class="card-header">
                    <h5>Фильтры для выбора текста</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="grading_header">Название текста:</label>
                            <input type="text" id="grading_header" class="form-control" 
                                placeholder="Поиск по названию...">
                        </div>
                        <div class="col-md-6">
                            <label for="grading_academic_year">Учебный год:</label>
                            <select id="grading_academic_year" class="form-control">
                                <option value="">Все годы</option>
                                {% for year in academic_years %}
                                <option value="{{ year.idayear }}">{{ year.academicyearname }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="grading_group">Учебная группа:</label>
                            <select id="grading_group" class="form-control">
                                <option value="">Все группы</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="grading_text_type">Тип текста:</label>
                            <select id="grading_text_type" class="form-control">
                                <option value="">Все типы</option>
                                {% for text_type in text_types %}
                                <option value="{{ text_type.idtexttype }}">{{ text_type.texttypename }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <button type="button" id="apply_grading_filters" class="btn btn-primary">
                        Применить фильтры
                    </button>
                    <button type="button" id="reset_grading_filters" class="btn btn-secondary">
                        Сбросить
                    </button>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h5>Выберите текст для оценивания</h5>
                    <small class="text-muted">
                        Показаны только тексты с оценкой. Тексты выбранного студента исключены.
                    </small>
                </div>
                <div class="card-body">
                    <div id="grading-texts-list" class="list-group" style="max-height: 400px; overflow-y: auto;">
                        <div class="text-center p-3">
                            <p class="text-muted">Примените фильтры для загрузки текстов</p>
                        </div>
                    </div>
                    
                    <div id="selected-grading-text" class="mt-3 p-3 border rounded" style="display: none;">
                        <h6>Выбранный текст:</h6>
                        <p id="selected-grading-text-info" class="mb-0"></p>
                    </div>

                    <div style="display: none;">
                        {{ form.grading_text }}
                    </div>
                </div>
            </div>
        </div>

        <div id="review-fields" style="display: none;">
            <div class="form-group">
                <label>Выберите текст для рецензирования:</label>
                <div class="texts-list" id="texts-list">
                    <div class="loading" id="texts-loading">
                        Загрузка текстов...
                    </div>
                </div>
                <div id="texts-error" class="error-message" style="display: none;"></div>
            </div>

            <div class="form-group" id="tasks-section" style="display: none;">
                <label>Выберите задание:</label>
                <div class="tasks-list" id="tasks-list">
                </div>
                <div id="tasks-error" class="error-message" style="display: none;"></div>
            </div>

            <div class="selected-info" id="selection-info" style="display: none;">
                <h5>Выбрано:</h5>
                <div id="selected-text-info">
                    <strong>Текст:</strong> <span id="selected-text-name">Не выбран</span>
                </div>
                <div id="selected-task-info" style="margin-top: 8px;">
                    <strong>Задание:</strong> <span id="selected-task-title">Не выбрано</span>
                </div>
            </div>
        </div>

        <div class="hidden-fields">
            {{ form.review_text_id }}
            {{ form.review_task_id }}
            {{ form.review_exercisetext }}
        </div>

        {% if form.non_field_errors %}
        <div class="alert alert-danger">
            {% for error in form.non_field_errors %}
            <p>{{ error }}</p>
            {% endfor %}
        </div>
        {% endif %}
        <button type="submit" class="button">Создать упражнение</button>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const groupSelect = document.getElementById("id_group");
    const yearSelect = document.getElementById("id_year");
    const studentSelect = document.getElementById("id_idstudent");
    const exerciseTypeRadios = document.querySelectorAll('input[name="idexercisetype"]');
    const gradingFields = document.getElementById('grading-fields');
    const reviewFields = document.getElementById('review-fields');
    
    // Скрытые поля для review
    const reviewTextIdInput = document.getElementById('id_review_text_id');
    const reviewTaskIdInput = document.getElementById('id_review_task_id');
    
    // Элементы для списков
    const textsList = document.getElementById('texts-list');
    const tasksList = document.getElementById('tasks-list');
    const tasksSection = document.getElementById('tasks-section');
    const selectionInfo = document.getElementById('selection-info');
    const selectedTextName = document.getElementById('selected-text-name');
    const selectedTaskTitle = document.getElementById('selected-task-title');
    
    let selectedTextId = null;
    let selectedTaskId = null;

    // Загрузка групп по учебному году
    yearSelect.addEventListener("change", function () {
        const yearId = this.value;
        if (!yearId) return;
        
        fetch("{% url 'load_groups' %}?yearId=" + yearId)
            .then(response => response.json())
            .then(data => {
                console.log(data);
                groupSelect.innerHTML = '<option value="">Выберите группу</option>';
                data.groups.forEach(group => {
                    const option = document.createElement("option");
                    option.value = group.id;
                    option.textContent = group.groupname;
                    groupSelect.appendChild(option);
                });
            });
    });

    // Загрузка студентов по группе
    groupSelect.addEventListener("change", function() {
        const groupId = this.value;
        if (!groupId) return;
        
        fetch("{% url 'load_students' %}?group_id=" + groupId)
            .then(response => response.json())
            .then(data => {
                studentSelect.innerHTML = '<option value="">Выберите студента</option>';
                data.students.forEach(student => {
                    const option = document.createElement("option");
                    option.value = student.id;
                    option.textContent = student.name;
                    studentSelect.appendChild(option);
                });
            });
    });

    exerciseTypeRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            gradingFields.style.display = 'none';
            reviewFields.style.display = 'none';            
            resetReviewSelection();
            
            if (this.value === '1') {  // код для grading
                gradingFields.style.display = 'flex';
                loadGradingTexts();
            } else if (this.value === '2') {  // код для review
                reviewFields.style.display = 'flex';
                loadTexts();
            }
        });
    });

    // Элементы для Grading
    const gradingTextsList = document.getElementById('grading-texts-list');
    const selectedGradingTextInfo = document.getElementById('selected-grading-text-info');
    const selectedGradingTextDiv = document.getElementById('selected-grading-text');
    const gradingTextHidden = document.getElementById('id_grading_text');
    let selectedGradingTextId = null;

    // Функция загрузки текстов для Grading
    function loadGradingTexts() {
        if (!gradingTextsList) return;
        const selectedStudentId = document.getElementById('id_idstudent')?.value;
        if (!selectedStudentId) {
            gradingTextsList.innerHTML = `
                <div class="alert alert-warning">
                    Сначала выберите студента в форме выше
                </div>
            `;
            return;
        }
        
        const params = new URLSearchParams({
            'exclude_student': selectedStudentId,
            'header': document.getElementById('grading_header')?.value || '',
            'academic_year': document.getElementById('grading_academic_year')?.value || '',
            'group': document.getElementById('grading_group')?.value || '',
            'text_type': document.getElementById('grading_text_type')?.value || ''
        });
        
        gradingTextsList.innerHTML = `
            <div class="text-center p-3">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Загрузка...</span>
                </div>
                <p>Загрузка текстов...</p>
            </div>
        `;
        
        fetch(`/exercise/gradingtexts/?${params}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Ошибка загрузки текстов: ${response.status}`);
                }
                return response.json();
            })
            .then(texts => {
                console.log('Получено текстов для оценивания:', texts.length);
                
                if (texts.length === 0) {
                    gradingTextsList.innerHTML = '<div class="alert alert-info">Тексты не найдены</div>';
                    return;
                }
                
                gradingTextsList.innerHTML = '';
                texts.forEach(text => {
                    const textItem = document.createElement('div');
                    textItem.className = 'list-group-item list-group-item-action grading-text-item';
                    textItem.dataset.textId = text.id;
                    textItem.innerHTML = `
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">${text.header}</h6>
                            <small>Оценка: ${text.grade}</small>
                        </div>
                        <p class="mb-1">
                            <strong>Студент:</strong> ${text.student}<br>
                            <strong>Группа:</strong> ${text.group} | 
                            <strong>Год:</strong> ${text.academic_year}<br>
                            <strong>Тип:</strong> ${text.text_type} | 
                            <strong>Дата:</strong> ${text.created_date}
                        </p>
                    `;
                    
                    textItem.addEventListener('click', function() {
                        document.querySelectorAll('.grading-text-item').forEach(item => {
                            item.classList.remove('active');
                        });

                        this.classList.add('active');

                        selectedGradingTextId = text.id;
                        if (gradingTextHidden) {
                            gradingTextHidden.value = text.id;
                        }

                        if (selectedGradingTextInfo) {
                            selectedGradingTextInfo.innerHTML = `
                                <strong>${text.header}</strong><br>
                                Студент: ${text.student}<br>
                                Группа: ${text.group}, Учебный год: ${text.academic_year}<br>
                                Тип: ${text.text_type}, Оценка: ${text.grade}
                            `;
                        }
                        
                        if (selectedGradingTextDiv) {
                            selectedGradingTextDiv.style.display = 'block';
                        }
                    });
                    
                    gradingTextsList.appendChild(textItem);
                });
            })
            .catch(error => {
                console.error('Ошибка загрузки текстов для оценивания:', error);
                gradingTextsList.innerHTML = '<div class="alert alert-danger">Ошибка загрузки текстов: ' + error.message + '</div>';
            });
    }

    // Загрузка групп для фильтра Grading
    document.getElementById('grading_academic_year')?.addEventListener('change', function() {
        const yearId = this.value;
        const groupSelect = document.getElementById('grading_group');
        
        if (!yearId) {
            groupSelect.innerHTML = '<option value="">Все группы</option>';
            return;
        }
        
        fetch(`{% url 'load_groups' %}?yearId=${yearId}`)
            .then(response => response.json())
            .then(groups => {
                groupSelect.innerHTML = '<option value="">Все группы</option>';
                groups.forEach(group => {
                    const option = document.createElement('option');
                    option.value = group.id;
                    option.textContent = group.groupname;
                    groupSelect.appendChild(option);
                });
            });
    });

    // Обработчики кнопок фильтров
    document.getElementById('apply_grading_filters')?.addEventListener('click', loadGradingTexts);

    document.getElementById('reset_grading_filters')?.addEventListener('click', function() {
        document.getElementById('grading_header').value = '';
        document.getElementById('grading_academic_year').value = '';
        document.getElementById('grading_group').value = '';
        document.getElementById('grading_text_type').value = '';
        selectedGradingTextId = null;
        if (gradingTextHidden) {
            gradingTextHidden.value = '';
        }
        if (selectedGradingTextDiv) {
            selectedGradingTextDiv.style.display = 'none';
        }
        
        document.querySelectorAll('.grading-text-item').forEach(item => {
            item.classList.remove('active');
        });
    });

    // Обновление текстов при изменении студента
    document.getElementById('id_idstudent')?.addEventListener('change', function() {
        const selectedRadio = document.querySelector('input[name="idexercisetype"]:checked');
        if (selectedRadio && selectedRadio.value === '1') {
            loadGradingTexts();
        }
    });
    
    // Функция сброса выбора для review
    function resetReviewSelection() {
        selectedTextId = null;
        selectedTaskId = null;
        reviewTextIdInput.value = '';
        reviewTaskIdInput.value = '';
        
        tasksSection.style.display = 'none';
        selectionInfo.style.display = 'none';
        selectedTextName.textContent = 'Не выбран';
        selectedTaskTitle.textContent = 'Не выбрано';
        if (tasksList) tasksList.innerHTML = '';
    }
    
    // Функция загрузки текстов для рецензирования
    function loadTexts() {
        textsList.innerHTML = '<div class="loading">Загрузка текстов...</div>';
        
        fetch("{% url 'get_review_texts' %}")
            .then(response => {
                if (!response.ok) {
                    throw new Error('Ошибка загрузки текстов');
                }
                return response.json();
            })
            .then(texts => {
                if (texts.length === 0) {
                    textsList.innerHTML = '<div class="loading">Нет доступных текстов</div>';
                    return;
                }
                
                textsList.innerHTML = '';
                texts.forEach(text => {
                    const textItem = document.createElement('div');
                    textItem.className = 'text-item';
                    textItem.dataset.textId = text.id;
                    textItem.innerHTML = `
                        <h5>${text.name}</h5>
                        <div class="text-meta">
                            Автор: ${text.author} | Дата: ${text.load_date}
                        </div>
                    `;
                    
                    textItem.addEventListener('click', function() {
                        document.querySelectorAll('.text-item').forEach(item => {
                            item.classList.remove('selected');
                        });
                        this.classList.add('selected');
                        selectedTextId = text.id;
                        reviewTextIdInput.value = text.id;
                        selectedTextName.textContent = text.name;
                        loadTasks(text.id);
                        selectionInfo.style.display = 'block';
                    });
                    
                    textsList.appendChild(textItem);
                });
            })
            .catch(error => {
                console.error('Ошибка загрузки текстов:', error);
                textsList.innerHTML = '<div class="loading" style="color: #f44336;">Ошибка загрузки текстов</div>';
            });
    }
    
    function loadTasks(textId) {
        console.log('Загрузка заданий для textId:', textId);
        console.log('Полный URL:', `/reviewtexts/${textId}/tasks/`);
        tasksSection.style.display = 'block';
        tasksList.innerHTML = '<div class="loading">Загрузка заданий...</div>';
        
        fetch(`/exercise/reviewtexts/${textId}/tasks/`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Ошибка загрузки заданий');
                }
                return response.json();
            })
            .then(tasks => {
                if (tasks.length === 0) {
                    tasksList.innerHTML = '<div class="loading">Нет заданий для этого текста</div>';
                    return;
                }
                
                tasksList.innerHTML = '';
                tasks.forEach(task => {
                    const taskItem = document.createElement('div');
                    taskItem.className = 'task-item';
                    taskItem.dataset.taskId = task.id;
                    taskItem.innerHTML = `
                        <h6>${task.title}</h6>
                        <div class="task-text">${task.text}</div>
                    `;
                    
                    taskItem.addEventListener('click', function() {
                        document.querySelectorAll('.task-item').forEach(item => {
                            item.classList.remove('selected');
                        });

                        this.classList.add('selected');
                        selectedTaskId = task.id;
                        reviewTaskIdInput.value = task.id;
                        selectedTaskTitle.textContent = task.title;
                    });
                    
                    tasksList.appendChild(taskItem);
                });
            })
            .catch(error => {
                console.error('Ошибка загрузки заданий:', error);
                tasksList.innerHTML = '<div class="loading" style="color: #f44336;">Ошибка загрузки заданий</div>';
            });
    }
    
    // Валидация формы перед отправкой
    document.getElementById('exerciseForm').addEventListener('submit', function(event) {
        const selectedRadio = document.querySelector('input[name="idexercisetype"]:checked');
        
        if (selectedRadio && selectedRadio.value === '1') {
            if (!selectedGradingTextId) {
                event.preventDefault();
                alert('выберите текст для поиска ошибок');
                return;
            }
        }

        if (selectedRadio && selectedRadio.value === '2') {
            if (!selectedTextId) {
                event.preventDefault();
                alert('выберите текст для рецензирования');
                return;
            }
            
            if (!selectedTaskId) {
                event.preventDefault();
                alert('выберите задание для рецензирования');
                return;
            }
        }
    });
});
</script>

{% endblock %}