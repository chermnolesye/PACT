{% load static %} 
{%block plugins%}
<script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
<script src="{% static 'js/external/axios.min.js' %}"></script>
<script src="{% static 'js/external/chart.umd.min.js' %}"></script>
<script src="{% static 'js/external/xlsx.full.min.js' %}"></script>
<script src="{% static 'js/external/bootstrap.bundle.min.js' %}"></script>
<script src="{% static 'js/external/jquery.min.js' %}"></script>
{%endblock plugins%} 

{% block link %}
<link rel="stylesheet" type="text/css" href="{% static 'css/dashboards.css' %}" />
<link rel="stylesheet" type="text/css" href="{% static 'css/external/bootstrap.min.css' %}" />
{% endblock link %}

{% block content %}
<main class="container-fluid mt-5 fs-5">
	<h2 class="text-primary text-center my-5">Количество ошибок в разрезе типов ошибок для заданной самооценки</h2>

	<div class="d-flex flex-column flex-md-row my-4 gap-4 justify-content-evenly">
		<div class="col">
			<label class="text-center text-primary"> Статистика </label>
			<hr class="mt-1"/>
			<select id="selected_stat" class="form-select" onchange="update_data()">
				<option>абсолютная</option>
				<option>на 100 токенов</option>
            </select>
		</div>

		<div id="signature" class="col">
			<label class="text-center text-primary"> Подписи на </label>
			<hr class="mt-1"/>
			{% verbatim %}
			<select class="form-select" v-model="selected_language_labels" @change="on_change_language_labels">
				<option v-for="language_label in language_labels">{{ language_label }}</option>
			</select>
			{% endverbatim %}
		</div>

		<div id="level_detail" class="col">
			<label class="text-center text-primary"> Уровень детализации </label>
			<hr class="mt-1"/>
			{% verbatim %}
			<select class="form-select" v-model="selected_level_detail" @change="on_change_level_detail">
				<option v-for="level in levels" :value="level.id_level">{{ level.level_text }}</option>
			</select>
			{% endverbatim %}
		</div>

		<div id="self_ratings" class="col">
			<label class="text-center text-primary"> Самооценивание </label>
			<hr class="mt-1"/>
			{% verbatim %}
			<select class="form-select" v-model="selected_self_rating" @change="on_change_self_rating">
				<option v-for="self_rating in self_ratings" :value="self_rating.selfrating">{{ self_rating.selfrating_text }}</option>
			</select>
			{% endverbatim %}
		</div>
	</div>

	<hr class="mt-5" />
	<div class="d-flex flex-column flex-md-row my-4 gap-4 justify-content-between">
		<div class="d-flex flex-column flex-md-row gap-4">
			<div class="col-0">
				<div class="d-flex flex-column flex-md-row gap-2">
					<div class="col-0">
						<label class="text-center text-primary"> Размер шрифта </label>
					</div>
					<div class="col">
						<select id="font_size" class="form-select" onchange="on_change_font_size()">
							<option>10</option>
							<option>11</option>
							<option>12</option>
							<option>13</option>
							<option>14</option>
							<option>15</option>
							<option selected>16</option>
							<option>17</option>
							<option>18</option>
							<option>19</option>
							<option>20</option>
						</select>
					</div>
				</div>
			</div>
			<div class="col">
				<div class="d-flex flex-column flex-md-row gap-2">
					<div class="col-0">
						<label class="text-center text-primary"> Класс ошибок </label>
					</div>
					<div id="tag_parents" class="col">
						{% verbatim %}
						<select class="form-select" v-model="selected_tag_parent" @change="on_change_tag_parent" >
							<option selected> -- </option>
							<option v-for="tag_parent in tag_parents":value="tag_parent.iderrortag">
								{{ tag_parent.tagtextrussian }}
							</option>
						</select>
						{% endverbatim %}
					</div>
				</div>
			</div>
		</div>
		<div class="d-flex flex-column flex-md-row gap-2">
			<div class="col">
				<button
					id="btn-filters"
					type="button"
					class="btn btn-outline-secondary shadow-none"
					title="Фильтры"
					data-bs-toggle="collapse"
					data-bs-target="#filters"
					aria-expanded="false"
					aria-controls="filters"
				>
					<svg
						class="bi"
						xmlns="http://www.w3.org/2000/svg"
						height="1.6em"
						stroke="currentColor"
						fill="none"
						viewBox="0 0 24 24"
					>
						<path
							stroke-linecap="round"
							stroke-width="1.5"
							d="M20.058 9.723c.948-.534 1.423-.801 1.682-1.232.26-.43.26-.949.26-1.987v-.69c0-1.326 0-1.99-.44-2.402C21.122 3 20.415 3 19 3H5c-1.414 0-2.121 0-2.56.412C2 3.824 2 4.488 2 5.815v.69c0 1.037 0 1.556.26 1.986.26.43.733.698 1.682 1.232l2.913 1.64c.636.358.955.537 1.183.735.474.411.766.895.898 1.49.064.284.064.618.064 1.285v2.67c0 .909 0 1.364.252 1.718.252.355.7.53 1.594.88 1.879.734 2.818 1.101 3.486.683.668-.417.668-1.372.668-3.282v-2.67c0-.666 0-1 .064-1.285a2.68 2.68 0 0 1 .899-1.49"
						/>
					</svg>
				</button>
			</div>
			<div class="col-0">
			 	<button id="btn-download" type="button" class="btn btn-primary" onclick="on_download()" >Скачать</button>
			</div>
		</div>
	</div>

	<div class="d-flex flex-column flex-md-row my-4 gap-4 justify-content-end">
		<div id="filters" class="collapse card card-rounded shadow-sm col-12">
			<div class="card-body">
				<form id="form_filters" name="filters">
					<div class="d-flex flex-column flex-md-row my-4 gap-4 justify-content-evenly">
						<div class="card col-5">
							<div class="card-header text-secondary" > Фильтры по студентам </div>
							<div id="filters_for_student" class="card-body">
								<div class="form-check">
									<input
										id="all"
										type="radio"
										name="student_filters"
										class="form-check-input"
										data-bs-toggle="collapse"
										data-bs-target="#none"
										aria-expanded="false"
										aria-controls="none"
										@change="on_change_choice_all"
										checked
									/>
									<label class="form-check-label text-filter" for="all"> Все </label>
									<span
										id="none"
										class="accordion-collapse collapse"
										data-bs-parent="#filters_for_student"
									></span>
								</div>

								<div class="form-check">
									<input
										id="groups"
										type="radio"
										name="student_filters"
										class="form-check-input"
										data-bs-toggle="collapse"
										data-bs-target="#group"
										aria-expanded="false"
										aria-controls="group"
										@change="on_change_choice_student_filters"
									/>
									<label class="form-check-label text-filter" for="groups"> Группа </label>
									<div
										id="group"
										class="accordion-collapse collapse"
										data-bs-parent="#filters_for_student"
									>
										<div class="row">
											<div class="col-8">
												<div class="input-group mb-2">
													<input 
														type="text" 
														class="form-control" 
														placeholder="Поиск группы..." 
														id="group_search"
														@input="on_group_search"
													>
												</div>
												{% verbatim %}
												<select
													id="filter_group"
													class="form-select"
													v-model="selected_group"
													size="6"
												>
													<option v-for="group in filtered_groups" 
															:value="group.idgroup">
														{{ group.groupname }} ({{ group.idayear__title }})
													</option>
												</select>
												{% endverbatim %}
											</div>
											<div class="col-4">
												<button type="button" class="btn btn-primary mt-4" @click="on_change_group">
													Применить
												</button>
											</div>
										</div>
										<div class="row">
											<div class="col-12">
												<div id="error_group" class="form-text error-message">
													выберите группу
												</div>
											</div>
										</div>
									</div>
								</div>

								<div class="form-check">
									<input
										id="students"
										type="radio"
										name="student_filters"
										class="form-check-input"
										data-bs-toggle="collapse"
										data-bs-target="#student"
										aria-expanded="false"
										aria-controls="student"
										@change="on_change_choice_student_filters"
									/>
									<label class="form-check-label text-filter" for="students"> Студент </label>
									<div
										id="student"
										class="accordion-collapse collapse"
										data-bs-parent="#filters_for_student"
									>
										<div class="row">
											<div class="col">
												<input
													id="surname"
													type="text"
													class="form-control"
													v-model="surname"
													placeholder="Фамилия"
												>
											</div>
											<div class="col">
												<input
													id="name"
													type="text"
													class="form-control"
													v-model="name"
													placeholder="Имя"
												>
											</div>
											<div class="col">
												<input
													type="text"
													class="form-control"
													v-model="patronymic"
													placeholder="Отчество"
												>
											</div>
											<div class="col">
												<button
													type="button"
													class="btn btn-primary"
													@click="on_change_student"
												>
													Применить
												</button>
											</div>
										</div>
										<div class="row">
											 <div class="col-3">
												 <div id="error_student_surname" class="form-text error-message">
													 введите фамилию
												 </div>
											 </div>
											<div class="col">
												<div id="error_student_name" class="form-text error-message">
													введите имя
												</div>
											</div>
										</div>
									</div>
								</div>

								<div class="form-check">
									<div class="row">
										<div class="col-1">
											<input
												id="courses"
												type="radio"
												name="student_filters"
												class="form-check-input"
												data-bs-toggle="collapse"
												data-bs-target="#course"
												aria-expanded="false"
												aria-controls="course"
												@change="on_change_choice_student_filters"
											/>
											<label class="form-check-label text-filter" for="courses"> Курс </label>
										</div>
										<div class="col-2">
											<div
												id="course"
												class="accordion-collapse collapse"
												data-bs-parent="#filters_for_student"
											>
												{% verbatim %}
												<select
													id="filter_course"
													class="form-select"
													v-model="selected_course"
													@change="on_change_course"
												>
													<option v-for="course in courses":value="course.studycourse">
														{{ course.studycourse }}
													</option>
												</select>
												{% endverbatim %}
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>

						<div class="card col-6">
							<div class="card-header text-secondary"> Фильтры по текстам </div>
							<div id="filters_for_texts" class="card-body">
								<div class="form-check">
									<div class="row">
										<div class="col-3">
											<input
												id="filter_all_texts"
												type="checkbox"
												value=""
												class="form-check-input"
												data-bs-toggle="collapse"
												data-bs-target="#header"
												aria-expanded="false"
												aria-controls="header"
												@change="on_change_choice_text"
											/>
											<label class="form-check-label text-filter" for="filter_all_texts">
												Название текста
											</label>
										</div>
										<div class="col-9">
											<div id="header" class="collapse">
												{% verbatim %}
												<select
													id="filter_text"
													class="form-select"
													v-model="selected_text"
													@change="on_change_text"
												>
													<option v-for="text in texts":value="text.header">
														{{ text.header }}
													</option>
												</select>
												{% endverbatim %}
											</div>
										</div>
									</div>
								</div>

								<div class="form-check">
									<div class="row">
										<div class="col-3">
											<input
												id="filter_text_types"
												type="checkbox"
												class="form-check-input"
												data-bs-toggle="collapse"
												data-bs-target="#text_type"
												aria-expanded="false"
												aria-controls="text_type"
												@change="on_change_choice_text_types"
											/>
											<label class="form-check-label text-filter" for="filter_text_types">
												Тип текста
											</label>
										</div>
										<div class="col-9">
											<div id="text_type" class="collapse">
												{% verbatim %}
												<select
													id="filter_text_type"
													class="form-select"
													v-model="selected_text_type"
													@change="on_change_text_type"
												>
													<option
														v-for="text_type in text_types":value="text_type.texttypename"
													>
														{{ text_type.texttypename }}
													</option>
												</select>
												{% endverbatim %}
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</form>
			</div>
		</div>
	</div>

	<hr class="mt-2" />
	<div id="legend_checked_filters">
	</div>

	<div id="diagrams" class="d-flex flex-column my-2">
		<div id="diagrams_self_rating_errors">
			<div id="self_rating_errors_bar" class="card my-3">
				<canvas id="bar_self_rating_errors" ref="chart" class="chart bar m-4"></canvas>
			</div>
			<div id="self_rating_errors_pie" class="card my-3">
				<canvas id="pie_self_rating_errors" ref="chart" class="chart pie m-4"></canvas>
			</div>
		</div>
	</div>
</main>
{% endblock content%} 

{%block script%}
<script type="text/javascript">
	var list_levels = {{levels | safe}}
	var list_self_ratings = {{self_ratings | safe}}
	var list_groups = {{groups | safe}}
	var list_enrollment_date = []
	var list_courses = {{courses | safe}}
	var list_texts = {{texts | safe}}
	var list_text_types = {{ text_types | safe}}
	var list_data = {{data | safe}}
	var list_tag_parents = {{tag_parents | safe}}
	let dict_children = {{dict_children | safe}}

	var data_for_language = list_data

	var colors = [
		'#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40',
		'#FF6384', '#C9CBCF', '#4BC0C0', '#FF9F40', '#36A2EB', '#FFCE56',
		'#9966FF', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF9F40', '#36A2EB'
	]

	var current_self_rating = ''
	var current_group = ''
	var current_enrollment_date = ''
	var current_surname = ''
	var current_name = ''
	var current_patronymic = ''
	var current_course = ''
	var current_text = ''
	var current_text_type = ''

	function getCookie(name) {
		let cookieValue = null;
		if (document.cookie && document.cookie !== '') {
			const cookies = document.cookie.split(';');
			for (let i = 0; i < cookies.length; i++) {
				const cookie = cookies[i].trim();
				if (cookie.substring(0, name.length + 1) === (name + '=')) {
					cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
					break;
				}
			}
		}
		return cookieValue;
	}

	async function post_request_data_errors(group, enrollment_date, surname, name, patronymic, course, text, text_type, level, self_rating) {
	    console.log("Requesting data with level:", level, "and self_rating:", self_rating);
	    var data = []

	    await axios({
	        method: 'post',
	        url: '',
	        data: {
	            'group': group,
	            'enrollment_date': enrollment_date,
	            'surname': surname,
	            'name': name,
	            'patronymic': patronymic,
	            'course': course,
	            'text': text,
	            'text_type': text_type,
	            'level': level,
	            'self_rating': self_rating, 
	            'flag_post': 'update_diagrams'
	        },
	        headers: {
	            'X-Requested-With': 'XMLHttpRequest',
	            'X-CSRFToken': getCookie('csrftoken')
	        }
	    })
	    .then(function (response) {
	        data = response.data.data_type_errors
	        console.log("Received data:", data);
	        if (data && data.length > 0) {
	            console.log("Sample data item:", data[0]);
	        }
	    })
	    .catch(function (error) {
	        console.error("Error fetching data:", error);
	    })

	    list_data = data
	    data_for_language = list_data

	    if (tag_parents_app) {
	        tag_parents_app.selected_tag_parent = '--'
	    }
	}

	function on_download() {
		var data = []
		data.push(["id_tag", "tag_parent", "tag_text", "tag_text_russian", "count_data", "count_data_on_tokens"])
		for (let i=0; i<data_for_language.length; i++) {
			data.push([
				data_for_language[i].iderrortag, 
				data_for_language[i].idtagparent,
				data_for_language[i].tagtext, 
				data_for_language[i].tagtextrussian, 
				data_for_language[i].count_data, 
				data_for_language[i].count_data_on_tokens
			]) 
		}

		var workbook = XLSX.utils.book_new(),
			worksheet = XLSX.utils.aoa_to_sheet(data)
		workbook.SheetNames.push("Errors")
		workbook.Sheets["Errors"] = worksheet

		XLSX.writeFile(workbook, `Errors_self_rating_${current_self_rating}_${level_detail_app.selected_level_detail}_level.xlsx`)
	}

	function update_data() {
	    console.log("Updating charts...");
	    console.log("Current data_for_language:", data_for_language);

	    var type_stat = document.getElementById("selected_stat").value;
	    if (type_stat == 'абсолютная') {
	        data_for_language.sort((a, b) => b.count_data - a.count_data);
	    } else {
	        data_for_language.sort((a, b) => (b.count_data_on_tokens || 0) - (a.count_data_on_tokens || 0));
	    }
	    
	    if (self_rating_errors_bar_app) {
	        self_rating_errors_bar_app.get_data()
	        self_rating_errors_bar_app.update_chart()
	    }
	    if (self_rating_errors_pie_app) {
	        self_rating_errors_pie_app.get_data()
	        self_rating_errors_pie_app.update_chart()
	    }
	}

	async function post_request_data() {
		console.log("Posting request with level:", level_detail_app.selected_level_detail, "and self_rating:", self_ratings_app.selected_self_rating);
		await post_request_data_errors(
			current_group, 
			current_enrollment_date,
			current_surname, 
			current_name,
			current_patronymic, 
			current_course, 
			current_text,
			current_text_type, 
			level_detail_app.selected_level_detail,
			self_ratings_app.selected_self_rating
		)
		update_data()
	}

	function update_legend_filters() {
		var container = document.getElementById("legend_checked_filters")
		container.innerHTML = ''

		var mainRow = document.createElement("div")
		mainRow.className = "d-flex flex-wrap gap-3 mt-4"

		if (current_self_rating) {
			var selfRatingCard = document.createElement("div")
			selfRatingCard.className = "card card-rounded shadow-sm border border-primary position-relative"
			selfRatingCard.style.paddingRight = "30px"
			
			var cardBody = document.createElement("div")
			cardBody.className = "card-body"
			
			var cardText = document.createElement("p")
			cardText.className = "card-text text-primary text-center mb-0"
			cardText.textContent = current_self_rating
			
			var closeBtn = document.createElement("button")
			closeBtn.type = "button"
			closeBtn.className = "btn-close position-absolute"
			closeBtn.style = "top: 5px; right: 5px;"
			closeBtn.onclick = function() {
				remove_filter('self_rating')
			}
			
			cardBody.appendChild(cardText)
			selfRatingCard.appendChild(cardBody)
			selfRatingCard.appendChild(closeBtn)
			mainRow.appendChild(selfRatingCard)
		}

		if (current_group && current_enrollment_date) {
			var groupCard = document.createElement("div")
			groupCard.className = "card card-rounded shadow-sm border border-primary position-relative"
			groupCard.style.paddingRight = "30px"
			
			var cardBody = document.createElement("div")
			cardBody.className = "card-body"
			
			var cardText = document.createElement("p")
			cardText.className = "card-text text-primary text-center mb-0"
			cardText.textContent = `${current_group} (${current_enrollment_date})`
			
			var closeBtn = document.createElement("button")
			closeBtn.type = "button"
			closeBtn.className = "btn-close position-absolute"
			closeBtn.style = "top: 5px; right: 5px;"
			closeBtn.onclick = function() {
				remove_filter('group')
			}
			
			cardBody.appendChild(cardText)
			groupCard.appendChild(cardBody)
			groupCard.appendChild(closeBtn)
			mainRow.appendChild(groupCard)
		}

		if (current_surname || current_name || current_patronymic) {
			var studentCard = document.createElement("div")
			studentCard.className = "card card-rounded shadow-sm border border-primary position-relative"
			studentCard.style.paddingRight = "30px"
			
			var cardBody = document.createElement("div")
			cardBody.className = "card-body"
			
			var studentName = [current_surname, current_name, current_patronymic].filter(Boolean).join(' ')
			var cardText = document.createElement("p")
			cardText.className = "card-text text-primary text-center mb-0"
			cardText.textContent = studentName
			
			var closeBtn = document.createElement("button")
			closeBtn.type = "button"
			closeBtn.className = "btn-close position-absolute"
			closeBtn.style = "top: 5px; right: 5px;"
			closeBtn.onclick = function() {
				remove_filter('student')
			}
			
			cardBody.appendChild(cardText)
			studentCard.appendChild(cardBody)
			studentCard.appendChild(closeBtn)
			mainRow.appendChild(studentCard)
		}

		if (current_course) {
			var courseCard = document.createElement("div")
			courseCard.className = "card card-rounded shadow-sm border border-primary position-relative"
			courseCard.style.paddingRight = "30px"
			
			var cardBody = document.createElement("div")
			cardBody.className = "card-body"
			
			var cardText = document.createElement("p")
			cardText.className = "card-text text-primary text-center mb-0"
			cardText.textContent = `${current_course} курс`
			
			var closeBtn = document.createElement("button")
			closeBtn.type = "button"
			closeBtn.className = "btn-close position-absolute"
			closeBtn.style = "top: 5px; right: 5px;"
			closeBtn.onclick = function() {
				remove_filter('course')
			}
			
			cardBody.appendChild(cardText)
			courseCard.appendChild(cardBody)
			courseCard.appendChild(closeBtn)
			mainRow.appendChild(courseCard)
		}

		if (current_text) {
			var textCard = document.createElement("div")
			textCard.className = "card card-rounded shadow-sm border border-primary position-relative"
			textCard.style.paddingRight = "30px"
			
			var cardBody = document.createElement("div")
			cardBody.className = "card-body"
			
			var cardText = document.createElement("p")
			cardText.className = "card-text text-primary text-center mb-0"
			cardText.textContent = current_text
			
			var closeBtn = document.createElement("button")
			closeBtn.type = "button"
			closeBtn.className = "btn-close position-absolute"
			closeBtn.style = "top: 5px; right: 5px;"
			closeBtn.onclick = function() {
				remove_filter('text')
			}
			
			cardBody.appendChild(cardText)
			textCard.appendChild(cardBody)
			textCard.appendChild(closeBtn)
			mainRow.appendChild(textCard)
		}

		if (current_text_type) {
			var textTypeCard = document.createElement("div")
			textTypeCard.className = "card card-rounded shadow-sm border border-primary position-relative"
			textTypeCard.style.paddingRight = "30px"
			
			var cardBody = document.createElement("div")
			cardBody.className = "card-body"
			
			var cardText = document.createElement("p")
			cardText.className = "card-text text-primary text-center mb-0"
			cardText.textContent = current_text_type
			
			var closeBtn = document.createElement("button")
			closeBtn.type = "button"
			closeBtn.className = "btn-close position-absolute"
			closeBtn.style = "top: 5px; right: 5px;"
			closeBtn.onclick = function() {
				remove_filter('text_type')
			}
			
			cardBody.appendChild(cardText)
			textTypeCard.appendChild(cardBody)
			textTypeCard.appendChild(closeBtn)
			mainRow.appendChild(textTypeCard)
		}

		container.appendChild(mainRow)
	}

	async function remove_filter(filterType) {
		switch(filterType) {
			case 'self_rating':
				current_self_rating = ''
				self_ratings_app.selected_self_rating = ''
				break
				
			case 'group':
				current_group = ''
				current_enrollment_date = ''
				filters_app.selected_group = ''
				document.getElementById('groups').checked = false
				document.getElementById('all').checked = true
				break
				
			case 'student':
				current_surname = ''
				current_name = ''
				current_patronymic = ''
				filters_app.surname = ''
				filters_app.name = ''
				filters_app.patronymic = ''
				document.getElementById('students').checked = false
				document.getElementById('all').checked = true
				break
				
			case 'course':
				current_course = ''
				filters_app.selected_course = ''
				document.getElementById('courses').checked = false
				document.getElementById('all').checked = true
				break
				
			case 'text':
				current_text = ''
				filters_app.selected_text = ''
				document.getElementById('filter_all_texts').checked = false
				break
				
			case 'text_type':
				current_text_type = ''
				filters_app.selected_text_type = ''
				document.getElementById('filter_text_types').checked = false
				break
		}
		
		await post_request_data()
		update_legend_filters()
	}

	var level_detail_app = new Vue({
	    el: '#level_detail',
	    data: {
	        levels: list_levels,
	        selected_level_detail: list_levels[0].id_level
	    },
	    methods: {
	        async on_change_level_detail() {
	            console.log("Level changed to:", this.selected_level_detail);
	            await post_request_data()
	        }
	    }
	})

	var self_ratings_app = new Vue({
		el: '#self_ratings',
		data: {
			self_ratings: list_self_ratings,
			selected_self_rating: ''
		},
		mounted() {
			if (this.self_ratings.length > 0) {
				this.selected_self_rating = this.self_ratings[0].selfrating;
				const self_rating = this.self_ratings.find(r => r.selfrating == this.selected_self_rating);
				current_self_rating = self_rating ? self_rating.selfrating_text : '';
				console.log("Auto-selected self-rating:", current_self_rating);
				post_request_data();
				update_legend_filters();
			}
		},
		methods: {
			async on_change_self_rating() {
				const self_rating = this.self_ratings.find(r => r.selfrating == this.selected_self_rating);
				current_self_rating = self_rating ? self_rating.selfrating_text : '';
				console.log("Self-rating changed to:", current_self_rating);
				await post_request_data();
				update_legend_filters();
			}
		}
	})

	var tag_parents_app = new Vue({
		el: '#tag_parents',
		data: {
			tag_parents: list_tag_parents,
			selected_tag_parent: '--'
		},
		methods: {
			on_change_tag_parent() {
				data_for_language = list_data

				if (this.selected_tag_parent != '--') {
					var grouped_data_for_tag = []
					var tag_children = dict_children[this.selected_tag_parent]
					
					for (let i=0; i<tag_children.length; i++) {
						var grouped_data = data_for_language.filter(data => data.iderrortag == tag_children[i])
						if (grouped_data.length != 0) {
							grouped_data_for_tag.push(grouped_data[0])
						}
					}

					data_for_language = grouped_data_for_tag

					var type_stat = document.getElementById("selected_stat").value;
					if (type_stat == 'абсолютная') {
						data_for_language.sort((x, y) => y.count_data - x.count_data)
					} else {
						data_for_language.sort((x, y) => (y.count_data_on_tokens || 0) - (x.count_data_on_tokens || 0))
					}
				}

				update_data()
			}
		}
	})

	var signature_app = new Vue({
		el: '#signature',
		data: {
			language_labels: ['Русском', 'Немецком'],
			selected_language_labels: 'Русском'
		},
		methods: {
			on_change_language_labels() {
				update_data()
			}
		}
	})

	var filters_app = new Vue({ 
		el: '#form_filters',
		data: {
			groups: list_groups,
			filtered_groups: list_groups,
			selected_group: '',
			group_search_query: '',
			surname: '',
			name: '',
			patronymic: '',
			courses: [...new Map(list_courses.map(item => [item.studycourse, item])).values()],
			selected_course: '',
			texts: list_texts,
			selected_text: '',
			text_types: list_text_types,
			selected_text_type: ''
		},
		methods: { 
			on_group_search(event) {
				this.group_search_query = event.target.value.toLowerCase();
				this.filter_groups();
			},
			
			filter_groups() {
				if (!this.group_search_query) {
					this.filtered_groups = this.groups;
				} else {
					this.filtered_groups = this.groups.filter(group => {
						const groupName = group.groupname ? group.groupname.toLowerCase() : '';
						const academicYear = group.idayear__title ? group.idayear__title.toLowerCase() : '';
						return groupName.includes(this.group_search_query) || 
							academicYear.includes(this.group_search_query) ||
							`${groupName} (${academicYear})`.toLowerCase().includes(this.group_search_query);
					});
				}
			},

			on_change_choice_student_filters() {
				if (document.getElementById('groups').checked) {
					this.group_search_query = '';
					this.filter_groups();
				}

				this.selected_group = ''
				this.surname = ''
				this.name = ''
				this.patronymic = ''
				this.selected_course = ''
			},

			async on_change_choice_all() {
				current_group = '';
				current_enrollment_date = '';
				current_surname = '';
				current_name = '';
				current_patronymic = '';
				current_course = '';
				current_text = '';
				current_text_type = '';
				
				this.selected_text = '';
				this.selected_text_type = '';
				document.getElementById('filter_all_texts').checked = false;
				document.getElementById('filter_text_types').checked = false;

				try {
					const response = await axios({
						method: 'post',
						url: '',
						data: {
							'flag_post': 'choice_all'
						},
						headers: {
							'X-Requested-With': 'XMLHttpRequest',
							'X-CSRFToken': getCookie('csrftoken')
						}
					});
					
					this.texts = response.data.texts;
					this.text_types = response.data.text_types;
				} catch (error) {
					console.error('Failed to get all texts:', error);
				}

				await post_request_data();
				update_legend_filters();
			},

			async on_change_group(){
				if (this.selected_group == '') {
					document.getElementById("error_group").style.display = 'block'
					document.getElementById("filter_group").classList.add('border', 'border-danger')
					return
				} else {
					document.getElementById("error_group").style.display = 'none'
					document.getElementById("filter_group").classList.remove('border', 'border-danger')
				}

				const selectedGroupObj = this.groups.find(g => g.idgroup == this.selected_group);
				if (selectedGroupObj) {
					current_group = selectedGroupObj.groupname;
					current_enrollment_date = selectedGroupObj.idayear__title;
					current_surname = '';
					current_name = '';
					current_patronymic = '';
					current_course = '';
					
					try {
						const response = await axios({
							method: 'post',
							url: '',
							data: {
								'group': current_group,
								'enrollment_date': current_enrollment_date,
								'flag_post': 'choice_group'
							},
							headers: {
								'X-Requested-With': 'XMLHttpRequest',
								'X-CSRFToken': getCookie('csrftoken')
							}
						});
						
						this.texts = response.data.texts;
						this.text_types = response.data.text_types;
					} catch (error) {
						console.error('Failed to get group texts:', error);
					}
					
					await post_request_data();
					update_legend_filters();
				}
			},

			async on_change_student() {
				if (!this.surname) {
					document.getElementById("error_student_surname").style.display = 'block'
					document.getElementById("surname").classList.add('border', 'border-danger')
				} else {
					document.getElementById("error_student_surname").style.display = 'none'
					document.getElementById("surname").classList.remove('border', 'border-danger')
				}

				if (!this.name) {
					document.getElementById("error_student_name").style.display = 'block'
					document.getElementById("name").classList.add('border', 'border-danger')
				} else {
					document.getElementById("error_student_name").style.display = 'none'
					document.getElementById("name").classList.remove('border', 'border-danger')
				}

				if (this.surname && this.name) {
					current_surname = this.surname;
					current_name = this.name;
					current_patronymic = this.patronymic;
					current_group = '';
					current_enrollment_date = '';
					current_course = '';
					
					try {
						const response = await axios({
							method: 'post',
							url: '',
							data: {
								'surname': current_surname,
								'name': current_name,
								'patronymic': current_patronymic,
								'flag_post': 'choice_student'
							},
							headers: {
								'X-Requested-With': 'XMLHttpRequest',
								'X-CSRFToken': getCookie('csrftoken')
							}
						});
						
						this.texts = response.data.texts;
						this.text_types = response.data.text_types;
					} catch (error) {
						console.error('Failed to get student texts:', error);
					}
					
					await post_request_data();
					update_legend_filters();
				}
			},

			async on_change_course() {
				if (this.selected_course) {
					current_course = this.selected_course;
					current_group = '';
					current_enrollment_date = '';
					current_surname = '';
					current_name = '';
					current_patronymic = '';
					
					try {
						const response = await axios({
							method: 'post',
							url: '',
							data: {
								'course': current_course,
								'flag_post': 'choice_course'
							},
							headers: {
								'X-Requested-With': 'XMLHttpRequest',
								'X-CSRFToken': getCookie('csrftoken')
							}
						});
						
						this.texts = response.data.texts;
						this.text_types = response.data.text_types;
					} catch (error) {
						console.error('Failed to get course texts:', error);
					}
					
					await post_request_data();
					update_legend_filters();
				}
			},

			async on_change_choice_text() {
				if (!document.getElementById('filter_all_texts').checked) {
					this.selected_text = ''
					await this.on_change_text()
				}
			},

			async on_change_text() {
				if (this.selected_text) {
					current_text = this.selected_text;
				} else {
					current_text = '';
				}
				
				await post_request_data();
				update_legend_filters();
			},

			async on_change_choice_text_types() {
				if (!document.getElementById('filter_text_types').checked) {
					this.selected_text_type = ''
					await this.on_change_text_type()
				}
			},

			async on_change_text_type() {
				if (this.selected_text_type) {
					current_text_type = this.selected_text_type;
				} else {
					current_text_type = '';
				}
				
				await post_request_data();
				update_legend_filters();
			}
		},
		mounted() {
			this.filtered_groups = this.groups;
		}
	})

	var self_rating_errors_bar_app = new Vue({
		el: '#self_rating_errors_bar',
		data: {
			chart: null,
			labels: [],
			stars: [],
			chart_type: 'bar',
			loading: false
		},
		mounted() {
			this.init_chart()
			this.get_data()
			this.update_chart()
		},
		methods: {
			init_chart() {
				var ctx = this.$refs.chart.getContext('2d')
				this.chart = new Chart(ctx, {
					type: this.chart_type,
					data: {
						labels: [],
						datasets: [{
							label: 'Количество ошибок',
							backgroundColor: 'crimson',
							borderColor: 'crimson',
							data: []
						}]
					},
					options: {
						responsive: true,
						plugins: {
							legend: {
								display: true
							},
							tooltip: {
								mode: 'index',
								callbacks: {
									label: function(context) {
										let label = context.dataset.label || '';
										if (label) {
											label += ': ';
										}
										const value = context.parsed.y;
										if (value !== null) {
											const type_stat = document.getElementById("selected_stat").value;
											if (type_stat === 'на 100 токенов') {
												label += value.toFixed(2);
											} else {
												label += Math.round(value);
											}
										}
										return label;
									}
								}
							}
						},
						scales: {
							y: {
								beginAtZero: true
							}
						}
					}
				})
			},
			update_chart() {
				if (this.chart) {
					this.chart.data.labels = this.labels
					this.chart.data.datasets[0].data = this.stars
					this.chart.update()
				}
			},
			get_data() {
				var labels = []
				var points = []
				var type_stat = document.getElementById("selected_stat").value

				var sorted_data = [...data_for_language];
				if (type_stat == 'абсолютная') {
					sorted_data.sort((a, b) => b.count_data - a.count_data);
				} else {
					sorted_data.sort((a, b) => (b.count_data_on_tokens || 0) - (a.count_data_on_tokens || 0));
				}

				for (let i=0; i<sorted_data.length; i++) {
					if (signature_app.selected_language_labels == 'Русском') {
						labels.push(sorted_data[i].tagtextrussian)
					} else {
						labels.push(sorted_data[i].tagtext)
					}
					
					if (type_stat == 'абсолютная') {
						points.push(sorted_data[i].count_data)
					} else {
						points.push(sorted_data[i].count_data_on_tokens || 0)
					}
				}

				this.labels = labels
				this.stars = points
			}
		}
	})

	var self_rating_errors_pie_app = new Vue({
    el: '#self_rating_errors_pie',
    data: {
        chart: null,
        labels: [],
        stars: [],
        chart_type: 'pie',
        loading: false
    },
    mounted() {
        this.init_chart()
        this.get_data()
        this.update_chart()
    },
    methods: {
        init_chart() {
            var ctx = this.$refs.chart.getContext('2d')

            const lineLabelPlugin = {
                id: 'lineLabels',
                afterDraw(chart) {
                    const ctx = chart.ctx;
                    ctx.save();
                    
                    const dataset = chart.data.datasets[0];
                    const meta = chart.getDatasetMeta(0);
                    const total = dataset.data.reduce((a, b) => a + b, 0);

                    const centerX = chart.chartArea.left + (chart.chartArea.right - chart.chartArea.left) / 2;
                    const centerY = chart.chartArea.top + (chart.chartArea.bottom - chart.chartArea.top) / 2;
                    const radius = Math.min(
                        (chart.chartArea.right - chart.chartArea.left) / 2,
                        (chart.chartArea.bottom - chart.chartArea.top) / 2
                    ) * 0.8;
                    
                    meta.data.forEach((element, index) => {
                        const percentage = total > 0 ? (dataset.data[index] / total) * 100 : 0;

                        if (percentage < 1.5) return;
                        
                        const label = chart.data.labels[index];
                        const shortLabel = label.length > 20 ? label.substring(0, 20) + '...' : label;
                        const labelText = `${shortLabel} (${percentage.toFixed(1)}%)`;

                        if (meta.data.length === 1) {
                            const textX = centerX + radius + 70;
                            const textY = centerY;

                            ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
                            ctx.strokeStyle = '#ccc';
                            ctx.lineWidth = 1;
                            const textWidth = ctx.measureText(labelText).width;
                            ctx.fillRect(textX - 5, textY - 8, textWidth + 10, 16);
                            ctx.strokeRect(textX - 5, textY - 8, textWidth + 10, 16);

                            ctx.fillStyle = '#333';
                            ctx.font = '11px Arial';
                            ctx.textAlign = 'left';
                            ctx.textBaseline = 'middle';
                            ctx.fillText(labelText, textX, textY);
                            
                            return; 
                        }

                        const startAngle = element.startAngle;
                        const endAngle = element.endAngle;
                        const midAngle = startAngle + (endAngle - startAngle) / 2;

                        const labelX = centerX + Math.cos(midAngle) * radius;
                        const labelY = centerY + Math.sin(midAngle) * radius;

                        const isLeft = labelX < centerX;
                        const lineLength = 60;

                        const lineEndX = labelX + Math.cos(midAngle) * lineLength;
                        const lineEndY = labelY + Math.sin(midAngle) * lineLength;

                        const textX = lineEndX + (isLeft ? -10 : 10);
                        const textY = lineEndY;

                        ctx.strokeStyle = '#666';
                        ctx.lineWidth = 1;
                        ctx.setLineDash([5, 3]);
                        ctx.beginPath();
                        ctx.moveTo(labelX, labelY);
                        ctx.lineTo(lineEndX, lineEndY);
                        ctx.stroke();
                        ctx.setLineDash([]);

                        const textWidth = ctx.measureText(labelText).width;
                        const textHeight = 16;

                        ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
                        ctx.strokeStyle = '#ccc';
                        ctx.lineWidth = 1;
                        
                        if (isLeft) {
                            ctx.fillRect(textX - textWidth - 8, textY - 8, textWidth + 10, textHeight);
                            ctx.strokeRect(textX - textWidth - 8, textY - 8, textWidth + 10, textHeight);
                        } else {
                            ctx.fillRect(textX - 2, textY - 8, textWidth + 10, textHeight);
                            ctx.strokeRect(textX - 2, textY - 8, textWidth + 10, textHeight);
                        }

                        ctx.fillStyle = '#333';
                        ctx.font = '11px Arial';
                        ctx.textAlign = isLeft ? 'right' : 'left';
                        ctx.textBaseline = 'middle';
                        ctx.fillText(labelText, isLeft ? textX - 5 : textX + 5, textY);
                    });
                    
                    ctx.restore();
                }
            };

            this.chart = new Chart(ctx, {
                type: this.chart_type,
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Тип ошибки',
                        backgroundColor: colors,
                        borderColor: function(context) {
                            const chart = context.chart;
                            const meta = chart.getDatasetMeta(0);
                            if (meta.data.length === 1) {
                                return 'transparent';
                            }
                            return '#000000';
                        },
                        borderWidth: function(context) {
                            const chart = context.chart;
                            const meta = chart.getDatasetMeta(0);
                            if (meta.data.length === 1) {
                                return 0;
                            }
                            return 0.3;
                        },
                        data: []
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false 
                        },
                        tooltip: {
                            enabled: true,
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) + '%' : '0%';
                                    return `${label}: ${value.toFixed(2)}% (${percentage})`;
                                }
                            }
                        }
                    },
                    layout: {
                        padding: {
                            left: 100,
                            right: 100,
                            top: 100,
                            bottom: 100
                        }
                    }
                },
                plugins: [lineLabelPlugin]
            })
        },
        update_chart() {
            if (this.chart) {
                this.chart.data.labels = this.labels
                this.chart.data.datasets[0].data = this.stars
                this.chart.update()
            }
        },
        get_data() {
            var labels = []
            var points = []
            var type_stat = document.getElementById("selected_stat").value

            let count = 0
            let count_on_tokens = 0
            for (let i=0; i<data_for_language.length; i++) {
                count += data_for_language[i].count_data
                count_on_tokens += data_for_language[i].count_data_on_tokens || 0
            }

            var sorted_data = [...data_for_language];
            if (type_stat == 'абсолютная') {
                sorted_data.sort((a, b) => b.count_data - a.count_data);
            } else {
                sorted_data.sort((a, b) => (b.count_data_on_tokens || 0) - (a.count_data_on_tokens || 0));
            }

            for (let i=0; i<sorted_data.length; i++) {
                if (signature_app.selected_language_labels == 'Русском') {
                    labels.push(sorted_data[i].tagtextrussian)
                } else {
                    labels.push(sorted_data[i].tagtext)
                }

                if (type_stat == 'абсолютная') {
                    points.push(count > 0 ? (sorted_data[i].count_data * 100 / count) : 0)
                } else {
                    const value = sorted_data[i].count_data_on_tokens || 0
                    points.push(count_on_tokens > 0 ? (value * 100 / count_on_tokens) : 0)
                }
            }

            this.labels = labels
            this.stars = points
        }
    }
})

	function on_change_font_size() {
		var size = document.getElementById("font_size").value
		Chart.defaults.font.size = parseInt(size)
		update_data()
	}

	document.addEventListener('DOMContentLoaded', function() {
		document.getElementById("error_group").style.display = 'none'
		document.getElementById("error_student_surname").style.display = 'none'
		document.getElementById("error_student_name").style.display = 'none'

		Chart.defaults.font.size = 16

		update_legend_filters();
	});
</script>
{%endblock script%}