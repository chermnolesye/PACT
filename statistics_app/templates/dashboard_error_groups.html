{% load static %} 
{%block plugins%}
<script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
<script src="{% static 'js/external/axios.min.js' %}"></script>
<script src="{% static 'js/external/chart.umd.min.js' %}"></script>
<script src="{% static 'js/external/xlsx.full.min.js' %}"></script>
<script src="{% static 'js/external/bootstrap.bundle.min.js' %}"></script>
<script src="{% static 'js/external/jquery.min.js' %}"></script>
{%endblock plugins%} 

{% block link %}
<link rel="stylesheet" type="text/css" href="{% static 'css/dashboards.css' %}" />
<link rel="stylesheet" type="text/css" href="{% static 'css/external/bootstrap.min.css' %}" />
{% endblock link %}

{% block content %}
<main class="container-fluid mt-5 fs-5">
	<h2 class="text-primary text-center my-5">Количество ошибок для заданного типа ошибки и выбранных групп</h2>

	<div class="d-flex flex-column flex-md-row my-4 gap-4 justify-content-evenly">
		<div class="col">
			<label class="text-center text-primary"> Статистика </label>
			<hr class="mt-1"/>
			<select id="selected_stat" class="form-select" onchange="on_change_type_static()">
				<option value="absolute">абсолютная</option>
				<option value="per_tokens">на 100 токенов</option>
            </select>
		</div>
	</div>

	<hr class="mt-5" />
	<form id="form_error_groups_filters" name="filters">
		<div class="d-flex flex-column flex-md-row my-4 gap-4 justify-content-evenly">
			<div class="col">
				<label class="text-center text-primary"> Группы </label>
				<div class="input-group mb-2">
					<input 
						type="text" 
						class="form-control" 
						placeholder="Поиск группы..." 
						id="group_search"
						@input="on_group_search"
					>
				</div>

				<div class="form-check mb-2">
					<input
						type="checkbox"
						class="form-check-input"
						id="select_all_groups"
						@change="on_select_all_groups"
						:checked="selected_groups.length === filtered_groups.length"
					>
					<label class="form-check-label text-filter" for="select_all_groups">
						Выбрать все группы
					</label>
				</div>

				<div class="groups-checkbox-container" style="max-height: 300px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 0.375rem; padding: 10px;">
					{% verbatim %}
					<div v-for="group in filtered_groups" :key="group.idgroup" class="form-check">
						<input
							type="checkbox"
							class="form-check-input"
							:id="'group_' + group.idgroup"
							:value="group.idgroup"
							v-model="selected_groups"
							@change="on_change_groups"
						>
						<label class="form-check-label" :for="'group_' + group.idgroup">
							{{ group.groupname }} ({{ group.idayear__title }})
						</label>
					</div>
					{% endverbatim %}
				</div>
				
				<div id="error_group" class="form-text error-message"> выберете хотя бы одну группу </div>
			</div>

			<div class="col">
				<label class="text-center text-primary"> Тип ошибки </label>
				<div class="row">
					<div class="col-8">
						{% verbatim %}
						<select id="filter_tag" class="form-select" v-model="selected_tag">
							<option v-for="tag in tags" :value="tag.iderrortag">{{ tag.tagtextrussian }}</option>
						</select>
						{% endverbatim %}
					</div>

					<div class="col form-check">
						<input
							id="tag_children"
							type="checkbox"
							class="form-check-input"
							v-model="checked_tag_children"
						/>
						<label class="form-check-label text-filter" for="tag_children"> вложенные ошибки </label>
					</div>
				</div>
				<div id="error_tag" class="form-text error-message"> выберете тип ошибки </div>

				<div class="d-flex flex-column flex-md-row justify-content-end mt-2">
					<div class="col-2">
						<button type="button" class="btn btn-primary" @click="on_choice_params">Применить</button>
					</div>
					<div class="col-0">
						<button
							id="btn-filters"
							type="button"
							class="btn btn-outline-secondary shadow-none"
							title="Фильтры"
							data-bs-toggle="collapse"
							data-bs-target="#filters"
							aria-expanded="false"
							aria-controls="filters"
							disabled
						>
							<svg
								class="bi"
								xmlns="http://www.w3.org/2000/svg"
								height="1.6em"
								stroke="currentColor"
								fill="none"
								viewBox="0 0 24 24"
							>
								<path
									stroke-linecap="round"
									stroke-width="1.5"
									d="M20.058 9.723c.948-.534 1.423-.801 1.682-1.232.26-.43.26-.949.26-1.987v-.69c0-1.326 0-1.99-.44-2.402C21.122 3 20.415 3 19 3H5c-1.414 0-2.121 0-2.56.412C2 3.824 2 4.488 2 5.815v.69c0 1.037 0 1.556.26 1.986.26.43.733.698 1.682 1.232l2.913 1.64c.636.358.955.537 1.183.735.474.411.766.895.898 1.49.064.284.064.618.064 1.285v2.67c0 .909 0 1.364.252 1.718.252.355.7.53 1.594.88 1.879.734 2.818 1.101 3.486.683.668-.417.668-1.372.668-3.282v-2.67c0-.666 0-1 .064-1.285a2.68 2.68 0 0 1 .899-1.49"
								/>
							</svg>
						</button>
					</div>
				</div>
			</div>
		</div>

		<div class="d-flex flex-column flex-md-row my-4 gap-4 justify-content-end">
			<div id="filters" class="collapse card card-rounded shadow-sm col-6">
				<div class="card-body">
					<div class="form-check">
						<div class="row">
							<div class="col-3">
								<input
									id="filter_all_texts"
									type="checkbox"
									class="form-check-input"
									data-bs-toggle="collapse"
									data-bs-target="#header"
									aria-expanded="false"
									aria-controls="header"
									@change="on_change_choice_text"
								/>
								<label class="form-check-label text-filter" for="filter_all_texts">
									Название текста
								</label>
							</div>
							<div class="col-9">
								<div id="header" class="collapse">
									{% verbatim %}
									<select
										id="filter_text"
										class="form-select"
										v-model="selected_text"
										@change="on_change_text"
									>
										<option v-for="text in texts" :value="text.header">{{ text.header }}</option>
									</select>
									{% endverbatim %}
								</div>
							</div>
						</div>
					</div>
					<div class="form-check">
						<div class="row">
							<div class="col-3">
								<input
									id="filter_text_types"
									type="checkbox"
									class="form-check-input"
									data-bs-toggle="collapse"
									data-bs-target="#text_type"
									aria-expanded="false"
									aria-controls="text_type"
									@change="on_change_choice_text_types"
								/>
								<label class="form-check-label text-filter" for="filter_text_types"> Тип текста </label>
							</div>
							<div class="col-9">
								<div id="text_type" class="collapse">
									{% verbatim %}
									<select
										id="filter_text_type"
										class="form-select"
										v-model="selected_text_type"
										@change="on_change_text_type"
									>
										<option v-for="text_type in text_types" :value="text_type.idtexttype">
											{{ text_type.texttypename }}
										</option>
									</select>
									{% endverbatim %}
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</form>

	<hr class="mt-4" />
	<div class="d-flex flex-column flex-md-row my-4 gap-4 justify-content-between">
		<div class="d-flex flex-column flex-md-row gap-2">
			<div class="col-0">
				<label class="text-center text-primary"> Размер шрифта </label>
			</div>
			<div class="col">
				<select id="font_size" class="form-select" onchange="on_change_font_size()">
					<option>10</option>
					<option>11</option>
					<option>12</option>
					<option>13</option>
					<option>14</option>
					<option>15</option>
					<option selected>16</option>
					<option>17</option>
					<option>18</option>
					<option>19</option>
					<option>20</option>
				</select>
			</div>
		</div>
		<div class="d-flex flex-column flex-md-row gap-2">
			<div class="col-0">
				<button id="btn-download" type="button" class="btn btn-primary" onclick="on_download()" disabled>
					Скачать
				</button>
			</div>
		</div>
	</div>

	<hr class="mt-2" />
	<div id="legend_checked_filters">
	</div>

	<div id="diagrams" class="d-flex flex-column my-2">
		<div id="diagrams_errors_groups">
			<div id="errors_groups_bar" class="card my-3">
				<canvas id="bar_errors_groups" ref="chart" class="chart bar m-4"></canvas>
			</div>
			<div id="errors_groups_pie" class="card my-3">
				<canvas id="pie_errors_groups" ref="chart" class="chart pie m-4"></canvas>
			</div>
		</div>
	</div>
</main>
{% endblock content%} 

{%block script%}
<script type="text/javascript">
var colors = [
    'rgba(255, 0, 0, 1)',
    'rgba(0, 255, 0, 1)',
    'rgba(0, 0, 255, 1)',
    'rgba(199, 21, 133, 1)',
    'rgba(255, 69, 0, 1)',
    'rgba(75, 0, 130, 1)',
    'rgba(255, 255, 0, 1)',
    'rgba(148, 0, 211, 1)',
    'rgba(139, 69, 19, 1)',
    'rgba(0, 128, 0, 1)',
    'rgba(188, 143, 143, 1)',
    'rgba(255, 0, 255, 1)',
    'rgba(128, 128, 0, 1)',

    'rgba(255, 0, 0, 0.9)',
    'rgba(0, 255, 0, 0.9)',
    'rgba(0, 0, 255, 0.9)',
    'rgba(199, 21, 133, 0.9)',
    'rgba(255, 69, 0, 0.9)',
    'rgba(75, 0, 130, 0.9)',
    'rgba(255, 255, 0, 0.9)',
    'rgba(148, 0, 211, 0.9)',
    'rgba(139, 69, 19, 0.9)',
    'rgba(0, 128, 0, 0.9)',
    'rgba(188, 143, 143, 0.9)',
    'rgba(255, 0, 255, 0.9)',
    'rgba(128, 128, 0, 0.9)',

    'rgba(255, 0, 0, 0.8)',
    'rgba(0, 255, 0, 0.8)',
    'rgba(0, 0, 255, 0.8)',
    'rgba(199, 21, 133, 0.8)',
    'rgba(255, 69, 0, 0.8)',
    'rgba(75, 0, 130, 0.8)',
    'rgba(255, 255, 0, 0.8)',
    'rgba(148, 0, 211, 0.8)',
    'rgba(139, 69, 19, 0.8)',
    'rgba(0, 128, 0, 0.8)',
    'rgba(188, 143, 143, 0.8)',
    'rgba(255, 0, 255, 0.8)',
    'rgba(128, 128, 0, 0.8)',

    'rgba(255, 0, 0, 0.7)',
    'rgba(0, 255, 0, 0.7)',
    'rgba(0, 0, 255, 0.7)',
    'rgba(199, 21, 133, 0.7)',
    'rgba(255, 69, 0, 0.7)',
    'rgba(75, 0, 130, 0.7)',
    'rgba(255, 255, 0, 0.7)',
    'rgba(148, 0, 211, 0.7)',
    'rgba(139, 69, 19, 0.7)',
    'rgba(0, 128, 0, 0.7)',
    'rgba(188, 143, 143, 0.7)',
    'rgba(255, 0, 255, 0.7)',
    'rgba(128, 128, 0, 0.7)',

    'rgba(255, 0, 0, 0.6)',
    'rgba(0, 255, 0, 0.6)',
    'rgba(0, 0, 255, 0.6)',
    'rgba(199, 21, 133, 0.6)',
    'rgba(255, 69, 0, 0.6)',
    'rgba(75, 0, 130, 0.6)',
    'rgba(255, 255, 0, 0.6)',
    'rgba(148, 0, 211, 0.6)',
    'rgba(139, 69, 19, 0.6)',
    'rgba(0, 128, 0, 0.6)',
    'rgba(188, 143, 143, 0.6)',
    'rgba(255, 0, 255, 0.6)',
    'rgba(128, 128, 0, 0.6)',

    'rgba(255, 0, 0, 0.5)',
    'rgba(0, 255, 0, 0.5)',
    'rgba(0, 0, 255, 0.5)',
    'rgba(199, 21, 133, 0.5)',
    'rgba(255, 69, 0, 0.5)',
    'rgba(75, 0, 130, 0.5)',
    'rgba(255, 255, 0, 0.5)',
    'rgba(148, 0, 211, 0.5)',
    'rgba(139, 69, 19, 0.5)',
    'rgba(0, 128, 0, 0.5)',
    'rgba(188, 143, 143, 0.5)',
    'rgba(255, 0, 255, 0.5)',
    'rgba(128, 128, 0, 0.5)',

    'rgba(255, 0, 0, 0.4)',
    'rgba(0, 255, 0, 0.4)',
    'rgba(0, 0, 255, 0.4)',
    'rgba(199, 21, 133, 0.4)',
    'rgba(255, 69, 0, 0.4)',
    'rgba(75, 0, 130, 0.4)',
    'rgba(255, 255, 0, 0.4)',
    'rgba(148, 0, 211, 0.4)',
    'rgba(139, 69, 19, 0.4)',
    'rgba(0, 128, 0, 0.4)',
    'rgba(188, 143, 143, 0.4)',
    'rgba(255, 0, 255, 0.4)',
    'rgba(128, 128, 0, 0.4)',
  ]

	var list_groups = {{groups | safe}}
	var list_texts = []
	var list_text_types = []
	var list_tags = {{tags | safe}}
	var list_data = []
	var selected_groups = []

	var current_tag_name = ''
	var current_text_name = ''
	var current_text_type_name = ''

	function on_change_font_size() {
		var selected_size = parseInt(document.getElementById("font_size").value);

		if (groups_bar.chart) {
			Chart.defaults.font.size = selected_size;
			groups_bar.chart.options.plugins.legend.labels.font.size = selected_size;
			groups_bar.chart.options.scales.x.ticks.font.size = selected_size;
			groups_bar.chart.options.scales.x.title.font.size = selected_size;
			groups_bar.chart.options.scales.y.ticks.font.size = selected_size;
			groups_bar.chart.options.scales.y.title.font.size = selected_size;
			groups_bar.chart.update();
		}

		if (groups_pie.chart) {
			Chart.defaults.font.size = selected_size;
			groups_pie.chart.options.plugins.legend.labels.font.size = selected_size;
			groups_pie.chart.update();
		}

		Chart.defaults.plugins.tooltip.titleFont = { size: selected_size };
		Chart.defaults.plugins.tooltip.bodyFont = { size: selected_size };
	}

	async function post_request_data_errors(text, text_type, groups, tag, checked_tag_children) {
		var data = []
		var texts = []
		var text_types = []

		await axios({
			method: 'post',
			url: '',
			data: {
				'text': text,
				'text_type': text_type,
				'group': groups,
				'tag': tag,
				'checked_tag_children': checked_tag_children
			},
			headers: {
				'X-Requested-With': 'XMLHttpRequest',
			}
		})
			.then(function (response) {
				data = response.data.data
				texts = response.data.texts
				text_types = response.data.text_types
			})

		list_data = data
		list_texts = texts
		list_text_types = text_types

		filters.texts = texts
		filters.text_types = text_types
	}

	function on_download() {
		var data = []

		var tag_selected = list_tags.find(tag => tag.iderrortag == filters.selected_tag)
		if (!tag_selected) return;

		if (filters.checked_tag_children) {
			data.push([tag_selected.tagtextrussian, 'с вложенными ошибками'])
		} else {
			data.push([tag_selected.tagtextrussian])
		}

		data.push(["Группа", "Учебный год", "Количество ошибок"])

		for (let i = 0; i < list_data.length; i++) {
			var item = list_data[i]
			var group_name = item.groupname || ''
			var academic_year = item.idayear__title || ''
			var count = item.count_data || 0
			data.push([group_name, academic_year, count])
		}

		var workbook = XLSX.utils.book_new()
		var worksheet = XLSX.utils.aoa_to_sheet(data)
		workbook.SheetNames.push("Errors")
		workbook.Sheets["Errors"] = worksheet

		XLSX.writeFile(workbook,
			`Errors_groups_${tag_selected.tagtextrussian}.xlsx`)
	}

	function update_data() {
		if (groups_bar.chart) {
			groups_bar.get_data()
			groups_bar.update_chart()
		}
		if (groups_pie.chart) {
			groups_pie.get_data()
			groups_pie.update_chart()
		}
	}

	function on_change_type_static() {
		var type_stat = document.getElementById("selected_stat").value
		if (type_stat == 'абсолютная') {
			list_data.sort((x, y) => y.count_data - x.count_data)
        } else {
        	list_data.sort((x, y) => y.count_data_on_tokens - x.count_data_on_tokens)
        }
        update_data()
	}

function update_legend_filters() {
    var container = document.getElementById("legend_checked_filters")
    container.innerHTML = '' 

    var mainRow = document.createElement("div")
    mainRow.className = "d-flex flex-wrap gap-3 mt-4" 

    if (current_tag_name) {
        var tagCard = document.createElement("div")
        tagCard.className = "card card-rounded shadow-sm border border-primary position-relative"
        tagCard.style.paddingRight = "30px"
        
        var cardBody = document.createElement("div")
        cardBody.className = "card-body"
        
        var cardText = document.createElement("p")
        cardText.className = "card-text text-primary text-center mb-0"
        cardText.textContent = filters.checked_tag_children ? 
            `Группа ошибок: ${current_tag_name}` : current_tag_name

        var closeBtn = document.createElement("button")
        closeBtn.type = "button"
        closeBtn.className = "btn-close position-absolute"
        closeBtn.style = "top: 5px; right: 5px;"
        closeBtn.onclick = function() {
            remove_filter('tag', '')
        }
        
        cardBody.appendChild(cardText)
        tagCard.appendChild(cardBody)
        tagCard.appendChild(closeBtn)
        mainRow.appendChild(tagCard)
    }

    if (current_text_name) {
        var textCard = document.createElement("div")
        textCard.className = "card card-rounded shadow-sm border border-primary position-relative"
        textCard.style.paddingRight = "30px"
        
        var cardBody = document.createElement("div")
        cardBody.className = "card-body"
        
        var cardText = document.createElement("p")
        cardText.className = "card-text text-primary text-center mb-0"
        cardText.textContent = current_text_name
        
        var closeBtn = document.createElement("button")
        closeBtn.type = "button"
        closeBtn.className = "btn-close position-absolute"
        closeBtn.style = "top: 5px; right: 5px;"
        closeBtn.onclick = function() {
            remove_filter('text', '')
        }
        
        cardBody.appendChild(cardText)
        textCard.appendChild(cardBody)
        textCard.appendChild(closeBtn)
        mainRow.appendChild(textCard)
    }

    if (current_text_type_name) {
        var textTypeCard = document.createElement("div")
        textTypeCard.className = "card card-rounded shadow-sm border border-primary position-relative"
        textTypeCard.style.paddingRight = "30px"
        
        var cardBody = document.createElement("div")
        cardBody.className = "card-body"
        
        var cardText = document.createElement("p")
        cardText.className = "card-text text-primary text-center mb-0"
        cardText.textContent = current_text_type_name
        
        var closeBtn = document.createElement("button")
        closeBtn.type = "button"
        closeBtn.className = "btn-close position-absolute"
        closeBtn.style = "top: 5px; right: 5px;"
        closeBtn.onclick = function() {
            remove_filter('text_type', '')
        }
        
        cardBody.appendChild(cardText)
        textTypeCard.appendChild(cardBody)
        textTypeCard.appendChild(closeBtn)
        mainRow.appendChild(textTypeCard)
    }

    container.appendChild(mainRow)

    if (filters.selected_groups && filters.selected_groups.length > 0) {
        var groupsRow = document.createElement("div")
        groupsRow.className = "d-flex flex-wrap gap-3 mt-2" 

        filters.selected_groups.forEach(function(groupId) {
            var groupInfo = list_groups.find(g => g.idgroup == groupId)
            if (groupInfo) {
                var groupCard = document.createElement("div")
                groupCard.className = "card card-rounded shadow-sm border border-primary position-relative"
                groupCard.style.paddingRight = "30px"
                
                var cardBody = document.createElement("div")
                cardBody.className = "card-body"
                
                var cardText = document.createElement("p")
                cardText.className = "card-text text-primary text-center mb-0"
                cardText.textContent = `${groupInfo.groupname} (${groupInfo.idayear__title})`
                
                var closeBtn = document.createElement("button")
                closeBtn.type = "button"
                closeBtn.className = "btn-close position-absolute"
                closeBtn.style = "top: 5px; right: 5px;"
                closeBtn.onclick = function() {
                    remove_filter('group', groupId)
                }
                
                cardBody.appendChild(cardText)
                groupCard.appendChild(cardBody)
                groupCard.appendChild(closeBtn)
                groupsRow.appendChild(groupCard)
            }
        })

        container.appendChild(groupsRow)
    }
}

	async function remove_filter(filterType, filterValue) {
		switch(filterType) {
			case 'tag':
				filters.selected_tag = ''
				current_tag_name = ''
				break
				
			case 'text':
				filters.selected_text = ''
				current_text_name = ''
				document.getElementById('filter_all_texts').checked = false
				break
				
			case 'text_type':
				filters.selected_text_type = ''
				current_text_type_name = ''
				document.getElementById('filter_text_types').checked = false
				break
				
			case 'group':
				var index = filters.selected_groups.indexOf(parseInt(filterValue))
				if (index > -1) {
					filters.selected_groups.splice(index, 1)
				}
				if (document.getElementById('select_all_groups').checked) {
					document.getElementById('select_all_groups').checked = false
				}
				break
		}

		if (filterType === 'tag') {
			list_data = []
			update_data()
			document.getElementById("btn-download").disabled = true
			document.getElementById("btn-filters").disabled = true
		} else {
			if (filters.selected_tag) {
				await filters.update_diagrams()
			}
		}
		
		update_legend_filters()
	}

	var filters = new Vue({
		el: '#form_error_groups_filters',
		data: {
			groups: list_groups,
			filtered_groups: list_groups,
			selected_groups: [],
			tags: list_tags,
			selected_tag: '',
			texts: [],
			selected_text: '',
			text_types: [],
			selected_text_type: '',
			checked_tag_children: false,
			group_search_query: ''
		},
		methods: {
			on_select_all_groups(event) {
				if (event.target.checked) {
					this.selected_groups = this.filtered_groups.map(group => group.idgroup)
				} else {
					this.selected_groups = []
				}
				update_legend_filters()
				this.on_change_groups()
			},

			async on_change_groups() {
				update_legend_filters()

				if (this.selected_tag && this.selected_groups.length > 0) {
					await this.update_texts_for_selected_groups()
				} else {
					this.texts = []
					this.selected_text = ''
					current_text_name = ''
					update_legend_filters()
				}
			},

			async update_texts_for_selected_groups() {
				if (!this.selected_tag || this.selected_groups.length === 0) {
					this.texts = []
					return
				}
				
				try {
					await axios({
						method: 'post',
						url: '',
						data: {
							'text': '',
							'text_type': '',
							'group': this.selected_groups,
							'tag': this.selected_tag,
							'checked_tag_children': this.checked_tag_children
						},
						headers: {
							'X-Requested-With': 'XMLHttpRequest',
						}
					})
					.then(function (response) {
						filters.texts = response.data.texts
						if (filters.selected_text && !filters.texts.some(text => text.header === filters.selected_text)) {
							filters.selected_text = ''
							current_text_name = ''
						}
						update_legend_filters()
					})
				} catch (error) {
					console.error('Error updating texts:', error)
					this.texts = []
				}
			},
			
			async update_diagrams() {
				await post_request_data_errors(
					this.selected_text, 
					this.selected_text_type, 
					this.selected_groups,
					this.selected_tag, 
					this.checked_tag_children
				)
				document.getElementById("selected_stat").value = 'абсолютная'
				update_data()
			},
			
			async on_choice_params() {
				let hasErrors = false

				if (!this.selected_tag) {
					document.getElementById("error_tag").style.display = "block"
					document.getElementById("filter_tag").classList.add('border', 'border-danger')
					hasErrors = true
				} else {
					document.getElementById("error_tag").style.display = "none"
					document.getElementById("filter_tag").classList.remove('border', 'border-danger')
				}

				if (this.selected_groups.length == 0) {
					document.getElementById("error_group").style.display = 'block'
					hasErrors = true
				} else {
					document.getElementById("error_group").style.display = 'none'
				}

				if (hasErrors) return

				var tag = list_tags.find(tag => tag.iderrortag == this.selected_tag)
				if (tag) {
					current_tag_name = tag.tagtextrussian
				}

				if (this.selected_text) {
					current_text_name = this.selected_text
				}
				if (this.selected_text_type) {
					var text_type_obj = list_text_types.find(t => t.idtexttype == this.selected_text_type)
					if (text_type_obj) {
						current_text_type_name = text_type_obj.texttypename
					}
				}

				document.getElementById("btn-download").disabled = false
				document.getElementById("btn-filters").disabled = false

				await this.update_diagrams()
				update_legend_filters()
			},
			
			async on_change_choice_text() {
				if (!document.getElementById('filter_all_texts').checked) {
					this.selected_text = ''
					await this.update_diagrams()
					current_text_name = ''
					update_legend_filters()
				}
			},
			
			async on_change_text() {
				await this.update_diagrams()
				current_text_name = this.selected_text
				update_legend_filters()
			},
			
			async on_change_choice_text_types() {
				if (!document.getElementById('filter_text_types').checked) {
					this.selected_text_type = ''
					await this.update_diagrams()
					current_text_type_name = ''
					update_legend_filters()
				}
			},
			
			async on_change_text_type() {
				await this.update_diagrams()
				var text_type = list_text_types.find(text_type => text_type.idtexttype == this.selected_text_type)
				if (text_type) {
					current_text_type_name = text_type.texttypename
					update_legend_filters()
				}
			},
			
			on_group_search(event) {
				this.group_search_query = event.target.value.toLowerCase();
				this.filter_groups();
			},
			
			filter_groups() {
				if (!this.group_search_query) {
					this.filtered_groups = this.groups;
				} else {
					this.filtered_groups = this.groups.filter(group => {
						const groupName = group.groupname ? group.groupname.toLowerCase() : '';
						const academicYear = group.idayear__title ? group.idayear__title.toLowerCase() : '';
						return groupName.includes(this.group_search_query) || 
							academicYear.includes(this.group_search_query) ||
							`${groupName} (${academicYear})`.toLowerCase().includes(this.group_search_query);
					});
				}
			}
		},
		mounted() {
			this.filtered_groups = this.groups;
		}
	})

	var groups_bar = new Vue({
	    el: '#errors_groups_bar',
	    data: {
	        chart: {},
	        labels: [],
	        data_points: [],
	        chart_type: 'bar'
	    },
	    methods: {
	        mounted() {
	            this.init_chart()
	            this.get_data()
	            this.update_chart()
	        },
	        init_chart() {
	            this.chart = Vue.markRaw(new Chart(this.$refs.chart, {
	                type: this.chart_type,
	                data: {
	                    labels: [],
	                    datasets: [{
	                        label: 'Количество ошибок',
	                        backgroundColor: 'crimson',
	                        borderColor: 'crimson',
	                        data: []
	                    }]
	                },
	                options: {
	                    responsive: true,
	                    plugins: {
	                        legend: {
	                            position: 'bottom',
	                            labels: {
	                                font: {
	                                    size: 16 
	                                }
	                            }
	                        },
	                        tooltip: {
	                            titleFont: { size: 16 },
	                            bodyFont: { size: 16 }
	                        }
	                    },
	                    scales: {
	                        y: {
	                            beginAtZero: true,
	                            title: {
	                                display: true,
	                                text: 'Количество ошибок',
	                                font: {
	                                    size: 16
	                                }
	                            },
	                            ticks: {
	                                font: {
	                                    size: 16
	                                }
	                            }
	                        },
	                        x: {
	                            title: {
	                                display: true,
	                                text: 'Группы',
	                                font: {
	                                    size: 16
	                                }
	                            },
	                            ticks: {
	                                font: {
	                                    size: 16
	                                }
	                            }
	                        }
	                    }
	                }
	            }));
	        },
	        update_chart() {
	            this.chart.data.labels = this.labels
	            this.chart.data.datasets[0].data = this.data_points
	            this.chart.update()
	        },
	        get_data() {
				var labels = []
				var points = []
				var type_stat = document.getElementById("selected_stat").value

				for (let i = 0; i < list_data.length; i++) {
					var item = list_data[i]
					
					var group_name = item.groupname || ''
					var academic_year = item.idayear__title || ''
					var group_display = group_name && academic_year ? 
						`${group_name} (${academic_year})` : 
						(group_name || 'Неизвестная группа')
					
					labels.push(group_display)

					if (type_stat == 'абсолютная') {
						points.push(item.count_data || 0)
					} else {
						points.push(item.count_data_on_tokens || item.count_data || 0)
					}
				}

				this.labels = labels
				this.data_points = points
			}
	    },
	    mounted() {
	        this.mounted()
	    }
	})

var groups_pie = new Vue({
    el: '#errors_groups_pie',
    data: {
        chart: {},
        labels: [],
        data_points: [],
        chart_type: 'pie'
    },
    methods: {
        mounted() {
            this.init_chart()
            this.get_data()
            this.update_chart()
        },
        init_chart() {
            var ctx = this.$refs.chart.getContext('2d')

            const lineLabelPlugin = {
                id: 'lineLabels',
                afterDraw(chart) {
                    const ctx = chart.ctx;
                    ctx.save();
                    
                    const dataset = chart.data.datasets[0];
                    const meta = chart.getDatasetMeta(0);
                    const total = dataset.data.reduce((a, b) => a + b, 0);

                    const centerX = chart.chartArea.left + (chart.chartArea.right - chart.chartArea.left) / 2;
                    const centerY = chart.chartArea.top + (chart.chartArea.bottom - chart.chartArea.top) / 2;
                    const radius = Math.min(
                        (chart.chartArea.right - chart.chartArea.left) / 2,
                        (chart.chartArea.bottom - chart.chartArea.top) / 2
                    ) * 0.8;
                    
                    meta.data.forEach((element, index) => {
                        const percentage = total > 0 ? (dataset.data[index] / total) * 100 : 0;

                        if (percentage < 1.5) return;
                        
                        const label = chart.data.labels[index];
                        const shortLabel = label.length > 20 ? label.substring(0, 20) + '...' : label;
                        const labelText = `${shortLabel} (${percentage.toFixed(1)}%)`;

                        if (meta.data.length === 1) {
                            const textX = centerX + radius + 70;
                            const textY = centerY;

                            ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
                            ctx.strokeStyle = '#ccc';
                            ctx.lineWidth = 1;
                            const textWidth = ctx.measureText(labelText).width;
                            ctx.fillRect(textX - 5, textY - 8, textWidth + 10, 16);
                            ctx.strokeRect(textX - 5, textY - 8, textWidth + 10, 16);

                            ctx.fillStyle = '#333';
                            ctx.font = '11px Arial';
                            ctx.textAlign = 'left';
                            ctx.textBaseline = 'middle';
                            ctx.fillText(labelText, textX, textY);
                            
                            return; 
                        }

                        const startAngle = element.startAngle;
                        const endAngle = element.endAngle;
                        const midAngle = startAngle + (endAngle - startAngle) / 2;

                        const labelX = centerX + Math.cos(midAngle) * radius;
                        const labelY = centerY + Math.sin(midAngle) * radius;

                        const isLeft = labelX < centerX;
                        const lineLength = 60;

                        const lineEndX = labelX + Math.cos(midAngle) * lineLength;
                        const lineEndY = labelY + Math.sin(midAngle) * lineLength;

                        const textX = lineEndX + (isLeft ? -10 : 10);
                        const textY = lineEndY;

                        ctx.strokeStyle = '#666';
                        ctx.lineWidth = 1;
                        ctx.setLineDash([5, 3]);
                        ctx.beginPath();
                        ctx.moveTo(labelX, labelY);
                        ctx.lineTo(lineEndX, lineEndY);
                        ctx.stroke();
                        ctx.setLineDash([]);

                        const textWidth = ctx.measureText(labelText).width;
                        const textHeight = 16;

                        ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
                        ctx.strokeStyle = '#ccc';
                        ctx.lineWidth = 1;
                        
                        if (isLeft) {
                            ctx.fillRect(textX - textWidth - 8, textY - 8, textWidth + 10, textHeight);
                            ctx.strokeRect(textX - textWidth - 8, textY - 8, textWidth + 10, textHeight);
                        } else {
                            ctx.fillRect(textX - 2, textY - 8, textWidth + 10, textHeight);
                            ctx.strokeRect(textX - 2, textY - 8, textWidth + 10, textHeight);
                        }

                        ctx.fillStyle = '#333';
                        ctx.font = '11px Arial';
                        ctx.textAlign = isLeft ? 'right' : 'left';
                        ctx.textBaseline = 'middle';
                        ctx.fillText(labelText, isLeft ? textX - 5 : textX + 5, textY);
                    });
                    
                    ctx.restore();
                }
            };

            this.chart = new Chart(ctx, {
                type: this.chart_type,
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Количество ошибок',
                        backgroundColor: colors,
                        borderColor: function(context) {
                            const chart = context.chart;
                            const meta = chart.getDatasetMeta(0);
                            if (meta.data.length === 1) {
                                return 'transparent';
                            }
                            return '#000000';
                        },
                        borderWidth: function(context) {
                            const chart = context.chart;
                            const meta = chart.getDatasetMeta(0);
                            if (meta.data.length === 1) {
                                return 0;
                            }
                            return 0.3;
                        },
                        data: []
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false 
                        },
                        tooltip: {
                            enabled: true,
                            titleFont: { size: 16 },
                            bodyFont: { size: 16 }
                        }
                    },
                    layout: {
                        padding: {
                            left: 100,
                            right: 100,
                            top: 100,
                            bottom: 100
                        }
                    }
                },
                plugins: [lineLabelPlugin]
            });
        },
        update_chart() {
            this.chart.data.labels = this.labels
            this.chart.data.datasets[0].data = this.data_points
            this.chart.update()
        },
        get_data() {
            var labels = []
            var points = []
            var type_stat = document.getElementById("selected_stat").value

            var total = 0
            for (let i = 0; i < list_data.length; i++) {
                if (type_stat == 'абсолютная') {
                    total += list_data[i].count_data || 0
                } else {
                    total += list_data[i].count_data_on_tokens || list_data[i].count_data || 0
                }
            }

            if (total === 0) {
                this.labels = ['Нет данных']
                this.data_points = [100]
                return
            }

            var sorted_data = [...list_data].sort((a, b) => {
                if (type_stat == 'абсолютная') {
                    return (b.count_data || 0) - (a.count_data || 0)
                } else {
                    return ((b.count_data_on_tokens || b.count_data || 0) - (a.count_data_on_tokens || a.count_data || 0))
                }
            });

            for (let i = 0; i < sorted_data.length; i++) {
                var item = sorted_data[i]
                var group_name = item.groupname || ''
                var academic_year = item.idayear__title || ''
                var group_display = group_name && academic_year ? 
                    `${group_name} (${academic_year})` : 
                    (group_name || 'Неизвестная группа')
                
                labels.push(group_display)

                if (type_stat == 'абсолютная') {
                    var value = item.count_data || 0
                    var percentage = (value * 100 / total).toFixed(2)
                    points.push(parseFloat(percentage))
                } else {
                    var value = item.count_data_on_tokens || item.count_data || 0
                    var percentage = (value * 100 / total).toFixed(2)
                    points.push(parseFloat(percentage))
                }
            }

            this.labels = labels
            this.data_points = points
        }
    },
    mounted() {
        this.mounted()
    }
})

	document.addEventListener('DOMContentLoaded', function() {
		document.getElementById("error_tag").style.display = 'none'
		document.getElementById("error_group").style.display = 'none'
	})
</script>
{%endblock script%}