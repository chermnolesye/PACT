{% load static %} 
{%block plugins%}
<script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
<script src="{% static 'js/external/axios.min.js' %}"></script>
<script src="{% static 'js/external/chart.umd.min.js' %}"></script>
<script src="{% static 'js/external/xlsx.full.min.js' %}"></script>
<script src="{% static 'js/external/bootstrap.bundle.min.js' %}"></script>
<script src="{% static 'js/external/jquery.min.js' %}"></script>
{%endblock plugins%} 

{% block link %}
<link rel="stylesheet" type="text/css" href="{% static 'css/dashboards.css' %}" />
<link rel="stylesheet" type="text/css" href="{% static 'css/external/bootstrap.min.css' %}" />
{% endblock link %}

{% block content %}
<main class="container-fluid mt-5 fs-5">
	<h2 class="text-primary text-center my-5">Динамика студента по текстам для заданного типа ошибки</h2>

	<div class="d-flex flex-column flex-md-row my-4 gap-4 justify-content-evenly">
		<div class="col">
			<label class="text-center text-primary"> Статистика </label>
			<hr class="mt-1"/>
			<select id="selected_stat" class="form-select" onchange="update_data()">
				<option value="absolute">абсолютная</option>
				<option value="per_tokens">на 100 токенов</option>
            </select>
		</div>
	</div>

	<hr class="mt-5" />
	<form id="form_student_dynamics_filters" name="filters">
		<div class="d-flex flex-column flex-md-row my-4 gap-4 justify-content-evenly">
			<div class="col">
				<label class="text-center text-primary"> Тип ошибки </label>
				<div class="row">
					<div class="col">
						{% verbatim %}
						<select id="filter_tag" class="form-select" v-model="selected_tag">
							<option v-for="tag in tags" :value="tag.iderrortag">{{ tag.tagtextrussian }}</option>
						</select>
						{% endverbatim %}
					</div>

					<div class="col form-check">
						<input
							id="tag_children"
							type="checkbox"
							class="form-check-input"
							v-model="checked_tag_children"
						/>
						<label class="form-check-label text-filter" for="tag_children"> вложенные ошибки </label>
					</div>
				</div>
				<div class="row">
					 <div class="col">
						 <div id="error_tag" class="form-text error-message"> выберете тип ошибки </div>
					 </div>
				</div>
			</div>
			<div class="col">
				<label class="text-center text-primary"> Студент </label>
				<div class="row">
					<div class="col-3">
						<input id="surname" type="text" class="form-control" v-model="surname" placeholder="Фамилия">
					</div>
					<div class="col-3">
						<input id="name" type="text" class="form-control" v-model="name" placeholder="Имя">
					</div>
					<div class="col-3">
						<input type="text" class="form-control" v-model="patronymic" placeholder="Отчество">
					</div>
					<div class="col-2">
						<button type="button" class="btn btn-primary" @click="on_choice_params">Применить</button>
					</div>
				</div>
				<div class="row">
					 <div class="col-3">
						 <div id="error_student_surname" class="form-text error-message"> введите фамилию </div>
					 </div>
					<div class="col">
						<div id="error_student_name" class="form-text error-message"> введите имя </div>
					</div>
				</div>
			</div>
		</div>
	</form>

	<hr class="mt-4" />
	<div class="d-flex flex-column flex-md-row my-4 gap-4 justify-content-between">
		<div class="d-flex flex-column flex-md-row gap-2">
			<div class="col-0">
				<label class="text-center text-primary"> Размер шрифта </label>
			</div>
			<div class="col">
				<select id="font_size" class="form-select" onchange="on_change_font_size()">
					<option>10</option>
					<option>11</option>
					<option>12</option>
					<option>13</option>
					<option>14</option>
					<option>15</option>
					<option selected>16</option>
					<option>17</option>
					<option>18</option>
					<option>19</option>
					<option>20</option>
				</select>
			</div>
		</div>
		<div class="d-flex flex-column flex-md-row gap-2">
			<div class="col-0">
				<button id="btn-download" type="button" class="btn btn-primary" onclick="on_download()" disabled>
					Скачать
				</button>
			</div>
		</div>
	</div>

	<hr class="mt-2" />
	<div id="legend_checked_filters" class="d-flex flex-column flex-md-row gap-3 mt-4 justify-content-start">
		<div id="card_tag" class="card card-rounded shadow-sm card-display border border-primary">
			<div class="card-body">
				<p class="card-text text-primary" v-html="tag">{{tag}}</p>
			</div>
		</div>
		<div id="card_tag_children" class="card card-rounded shadow-sm card-display border border-primary">
			<div class="card-body">
				<p class="card-text text-primary"> Группа ошибок: <span v-html="tag">{{tag}}</span></p>
			</div>
		</div>
		<div id="card_student" class="card card-rounded shadow-sm card-display border border-primary">
			<div class="card-body">
				<p class="card-text text-primary">
					<span v-html="surname">{{surname}}</span>
					<span v-html="name">{{name}}</span>
					<span v-html="patronymic">{{patronymic}}</span>
				</p>
			</div>
		</div>
	</div>

	<div id="diagram" class="d-flex flex-column my-2">
		<div id="diagram_student_dynamics">
			<div id="student_dynamics_bar" class="card my-3">
				<canvas id="bar_student_dynamics" ref="chart" class="chart bar m-4"></canvas>
			</div>
		</div>
	</div>
</main>
{% endblock content%} 

{%block script%}
<script type="text/javascript">
	var list_tags = {{tags | safe}}
	var list_data = []
	var selected_tag = ''
	var selected_surname = ''
	var selected_name = ''
	var selected_patronymic = ''

	function formatDateToRussian(dateString) {
		if (!dateString) return '';
		const date = new Date(dateString);
		const day = date.getDate().toString().padStart(2, '0');
		const month = (date.getMonth() + 1).toString().padStart(2, '0');
		const year = date.getFullYear();
		return `${day}.${month}.${year}`;
	}

	function on_change_font_size() {
		var selected_size = parseInt(document.getElementById("font_size").value);
		
		if (student_dynamics_bar.chart) {
			student_dynamics_bar.chart.options.plugins.legend.labels.font.size = selected_size;
			student_dynamics_bar.chart.options.plugins.tooltip.titleFont = { size: selected_size };
			student_dynamics_bar.chart.options.plugins.tooltip.bodyFont = { size: selected_size };

			student_dynamics_bar.chart.options.scales.x.ticks.font.size = selected_size;
			student_dynamics_bar.chart.options.scales.x.title.font.size = selected_size;
			student_dynamics_bar.chart.options.scales.y.ticks.font.size = selected_size;
			student_dynamics_bar.chart.options.scales.y.title.font.size = selected_size;
			
			student_dynamics_bar.chart.update();
		}
	}

	async function post_request_data_errors(surname, name, patronymic, tag, checked_tag_children) {
		var data = []

		await axios({
			method: 'post',
			url: '',
			data: {
				'surname': surname,
				'name': name,
				'patronymic': patronymic,
				'tag': tag,
				'checked_tag_children': checked_tag_children
			},
			headers: {
				'X-Requested-With': 'XMLHttpRequest',
			}
		})
			.then(function (response) {
				data = response.data.data
			})

		list_data = data
	}

	function on_download() {
		var data = []

		var tag_selected = list_tags.find(tag => tag.iderrortag == filters.selected_tag)
		if (!tag_selected) return;

		if (filters.checked_tag_children) {
			data.push([tag_selected.tagtextrussian, 'с вложенными ошибками'])
		} else {
			data.push([tag_selected.tagtextrussian])
		}
		data.push([filters.surname, filters.name, filters.patronymic])

		data.push(["Дата создания", "Количество ошибок"])

		for (let i = 0; i < list_data.length; i++) {
			var item = list_data[i]
			var date = item.errortoken__idtoken__idsentence__idtext__createdate || item.createdate
			var count = item.count_data || 0
			data.push([formatDateToRussian(date), count])
		}

		var workbook = XLSX.utils.book_new()
		var worksheet = XLSX.utils.aoa_to_sheet(data)
		workbook.SheetNames.push("Dynamics")
		workbook.Sheets["Dynamics"] = worksheet

		XLSX.writeFile(workbook,
			`Student_dynamics_${filters.surname}_${filters.name}_${filters.patronymic}_${tag_selected.tagtextrussian}.xlsx`)
	}

	function update_data() {
		if (student_dynamics_bar.chart) {
			student_dynamics_bar.get_data()
			student_dynamics_bar.update_chart()
		}
	}

	var legend_filters = new Vue({
		el: '#legend_checked_filters',
		data: {
			surname: '',
			name: '',
			patronymic: '',
			tag: ''
		}
	})

	var filters = new Vue({
		el: '#form_student_dynamics_filters',
		data: {
			surname: '',
			name: '',
			patronymic: '',
			tags: list_tags,
			selected_tag: '',
			checked_tag_children: false
		},
		methods: {
			async update_diagrams() {
				await post_request_data_errors(
					selected_surname, 
					selected_name,
					selected_patronymic, 
					selected_tag, 
					this.checked_tag_children
				)
				update_data()
			},
			async on_choice_params() {
				let hasErrors = false

				if (!this.selected_tag) {
					document.getElementById("error_tag").style.display = "block"
					document.getElementById("filter_tag").classList.add('border', 'border-danger')
					hasErrors = true
				} else {
					document.getElementById("error_tag").style.display = "none"
					document.getElementById("filter_tag").classList.remove('border', 'border-danger')
				}

				if (!this.surname) {
					document.getElementById("error_student_surname").style.display = "block"
					document.getElementById("surname").classList.add('border', 'border-danger')
					hasErrors = true
				} else {
					document.getElementById("error_student_surname").style.display = "none"
					document.getElementById("surname").classList.remove('border', 'border-danger')
				}

				if (!this.name) {
					document.getElementById("error_student_name").style.display = "block"
					document.getElementById("name").classList.add('border', 'border-danger')
					hasErrors = true
				} else {
					document.getElementById("error_student_name").style.display = "none"
					document.getElementById("name").classList.remove('border', 'border-danger')
				}

				if (hasErrors) return

				selected_tag = this.selected_tag
				selected_surname = this.surname
				selected_name = this.name
				selected_patronymic = this.patronymic

				legend_filters.surname = this.surname
				legend_filters.name = this.name
				legend_filters.patronymic = this.patronymic

				var tag = list_tags.find(tag => tag.iderrortag == this.selected_tag)
				if (tag) {
					legend_filters.tag = tag.tagtextrussian
				}

				if (this.checked_tag_children) {
					document.getElementById("card_tag_children").style.display = 'block'
					document.getElementById("card_tag").style.display = 'none'
				} else {
					document.getElementById("card_tag").style.display = 'block'
					document.getElementById("card_tag_children").style.display = 'none'
				}

				document.getElementById("card_student").style.display = 'block'
				document.getElementById("btn-download").disabled = false

				await this.update_diagrams()
			}
		}
	})

	var student_dynamics_bar = new Vue({
		el: '#student_dynamics_bar',
		data: {
			chart: {},
			labels: [],
			data_points: [],
			chart_type: 'line',
			chartColor: 'crimson',
			loading: false
		},
		methods: {
			mounted() {
				this.init_chart()
				this.get_data()
				this.update_chart()
			},
			init_chart() {
				const ctx = this.$refs.chart
				const initialFontSize = 16
				
				this.chart = Vue.markRaw(new Chart(ctx, {
					type: this.chart_type,
					data: {
						labels: [],
						datasets: [{
							label: 'Динамика студента',
							backgroundColor: 'crimson',
							borderColor: 'crimson',
							data: [],
							pointBackgroundColor: 'crimson',
							pointBorderColor: 'white',
							pointBorderWidth: 2,
							pointRadius: 6,
							pointHoverRadius: 8,
							tension: 0.1
						}]
					},
					options: {
						responsive: true,
						maintainAspectRatio: false,
						plugins: {
							legend: {
								position: 'bottom',
								labels: {
									font: {
										size: initialFontSize
									}
								}
							},
							tooltip: {
								titleFont: { size: initialFontSize },
								bodyFont: { size: initialFontSize },
								callbacks: {
									title: function(tooltipItems) {
										return 'Дата: ' + tooltipItems[0].label;
									},
									label: function(context) {
										return 'Количество ошибок: ' + context.parsed.y;
									}
								}
							}
						},
						scales: {
							y: {
								beginAtZero: true,
								title: {
									display: true,
									text: 'Количество ошибок',
									font: {
										size: initialFontSize
									}
								},
								ticks: {
									font: {
										size: initialFontSize
									}
								}
							},
							x: {
								title: {
									display: true,
									text: 'Дата создания текста',
									font: {
										size: initialFontSize
									}
								},
								ticks: {
									font: {
										size: initialFontSize
									}
								}
							}
						}
					}
				}))
			},
			update_chart() {
				if (this.chart) {
					this.chart.data.labels = this.labels
					this.chart.data.datasets[0].data = this.data_points
					this.chart.update()
				}
			},
			get_data() {
				var labels = []
				var points = []

				for (let i = 0; i < list_data.length; i++) {
					var item = list_data[i]
					var date = item.errortoken__idtoken__idsentence__idtext__createdate || item.createdate
					var count = item.count_data || 0
					
					if (date) {
						labels.push(formatDateToRussian(date))
						points.push(count)
					}
				}

				this.labels = labels
				this.data_points = points
			}
		},
		mounted() {
			this.mounted()
		}
	})

	document.addEventListener('DOMContentLoaded', function() {
		document.getElementById("error_tag").style.display = 'none'
		document.getElementById("error_student_surname").style.display = 'none'
		document.getElementById("error_student_name").style.display = 'none'
		document.getElementById("card_tag").style.display = 'none'
		document.getElementById("card_tag_children").style.display = 'none'
		document.getElementById("card_student").style.display = 'none'
	})
</script>
{%endblock script%}